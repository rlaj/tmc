/*
 * Copyright 2010 - 2012 Leo Sutic <leo.sutic@gmail.com>
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * Modified by Yong Chen <chenyo@us.ibm.com> to clean up CSS3DVRRenderer
 * dispose method, disable gesture/mouse initiated zooming
 */
self.bigshot||(bigshot={},bigshot.Object={extend:function(t,e){for(var i in e.prototype)t.prototype[i]?t.prototype[i]._super=e.prototype[i]:t.prototype[i]=e.prototype[i]},resolve:function(t){for(var e=t.split("."),i=self,s=0;s<e.length;++s)i=i[e[s]];return i},validate:function(){},alertr:function(t){var e="";for(var i in t)e+=i+":"+t[i]+"\n";alert(e)},logr:function(t){var e="";for(var i in t)e+=i+":"+t[i]+"\n";console&&console.log(e)}},bigshot.Browser=function(){this.requestAnimationFrameFunction=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame||function(t){return setTimeout(t,0)}},bigshot.Browser.prototype={removeAllChildren:function(t){t.innerHTML=""},mouseEnter:function(t){var e=this.isAChildOf;return function(i){var s=i.relatedTarget;this===s||e(this,s)||t.call(this,i)}},isAChildOf:function(t,e){if(t===e)return!1;for(;e&&e!==t;)e=e.parentNode;return e===t},unregisterListener:function(t,e,i,s){"undefined"!=typeof t.removeEventListener?t.removeEventListener(e,i,s):"undefined"!=typeof t.detachEvent&&t.detachEvent("on"+e,i)},registerListener:function(t,e,i,s){"undefined"!=typeof t.addEventListener?"mouseenter"===e?t.addEventListener("mouseover",this.mouseEnter(i),s):"mouseleave"===e?t.addEventListener("mouseout",this.mouseEnter(i),s):t.addEventListener(e,i,s):"undefined"!=typeof t.attachEvent?t.attachEvent("on"+e,i):t["on"+e]=i},stopEventBubbling:function(t){t&&(t.stopPropagation?t.stopPropagation():t.cancelBubble=!0)},stopEventBubblingHandler:function(){var t=this;return function(e){return t.stopEventBubbling(e),!1}},stopMouseEventBubbling:function(t){this.registerListener(t,"mousedown",this.stopEventBubblingHandler(),!1),this.registerListener(t,"mouseup",this.stopEventBubblingHandler(),!1),this.registerListener(t,"mousemove",this.stopEventBubblingHandler(),!1)},getElementSize:function(t){var e={};return t.clientWidth&&(e.w=t.clientWidth),t.clientHeight&&(e.h=t.clientHeight),e},browserIsViewporting:function(){return window.innerWidth<=screen.width?!1:!0},getDevicePixelScale:function(){return this.browserIsViewporting()?screen.width/window.innerWidth:1},requestAnimationFrame:function(t,e){var i=this.requestAnimationFrameFunction;i(t,e)},getElementPosition:function(t){var e=new Object;e.x=0,e.y=0;for(var i=t;i;)e.x+=i.offsetLeft,e.y+=i.offsetTop,i.clientLeft&&(e.x+=i.clientLeft),i.clientTop&&(e.y+=i.clientTop),i.x&&(e.x+=i.x),i.y&&(e.y+=i.y),i=i.offsetParent;return e},createXMLHttpRequest:function(){try{return new ActiveXObject("Msxml2.XMLHTTP")}catch(t){}try{return new ActiveXObject("Microsoft.XMLHTTP")}catch(t){}try{return new XMLHttpRequest}catch(t){}return alert("XMLHttpRequest not supported"),null},makeOpacityTransition:function(t,e){void 0!=t.style.WebkitTransitionProperty?(t.style.opacity=1,t.style.WebkitTransitionProperty="opacity",t.style.WebkitTransitionTimingFunction="linear",t.style.WebkitTransitionDuration="1s",setTimeout(function(){t.addEventListener("webkitTransitionEnd",function(){e()}),t.style.opacity=0},0)):(t.style.opacity=0,e())}},bigshot.EventDispatcher=function(){this.eventListeners={}},bigshot.EventDispatcher.prototype={addEventListener:function(t,e){void 0==this.eventListeners[t]&&(this.eventListeners[t]=new Array),this.eventListeners[t].push(e)},removeEventListener:function(t){if(void 0!=this.eventListeners[t])for(var e=this.eventListeners[t],i=0;i<e.length;++i)if(e[i]===listener){e.splice(i,1),0==e.length&&delete this.eventListeners[t];break}},fireEvent:function(t,e){if(void 0!=this.eventListeners[t])for(var i=this.eventListeners[t],s=0;s<i.length;++s)i[s](e)}},bigshot.Event=function(t){this.bubbles=!1,this.cancelable=!1,this.currentTarget=null,this.defaultPrevented=!1,this.target=null,this.timeStamp=(new Date).getTime(),this.type=null,this.isTrusted=!1;for(var e in t)this[e]=t[e]},bigshot.Event.prototype={preventDefault:function(){this.defaultPrevented=!0}},bigshot.TimedWeakReference=function(t,e,i){this.object=null,this.hasObject=!1,this.fnCreate=t,this.fnDispose=e,this.lastAccess=(new Date).getTime(),this.hasTimer=!1,this.interval=i},bigshot.TimedWeakReference.prototype={dispose:function(){this.clear()},get:function(){return this.hasObject||(this.hasObject=!0,this.object=this.fnCreate(),this.startTimer()),this.lastAccess=(new Date).getTime(),this.object},clear:function(){this.hasObject&&(this.hasObject=!1,this.fnDispose(this.object),this.object=null,this.stopTimer())},stopTimer:function(){this.hasTimer&&(clearTimeout(this.timerId),this.hasTimer=!1)},startTimer:function(){if(!this.hasTimer){var t=this;this.hasTimer=!0,this.timerId=setTimeout(function(){t.hasTimer=!1,t.update()},this.interval)}},update:function(){if(this.hasObject){var t=(new Date).getTime();t-this.lastAccess>this.interval?this.clear():this.startTimer()}}},bigshot.ImageEvent=function(t){bigshot.Event.call(this,t)},bigshot.ImageEvent.prototype={},bigshot.Object.extend(bigshot.ImageEvent,bigshot.Event),bigshot.VREvent=function(t){bigshot.Event.call(this,t)},bigshot.VREvent.prototype={},bigshot.Object.extend(bigshot.VREvent,bigshot.Event),bigshot.FullScreen=function(t){this.container=t,this.isFullScreen=!1,this.savedBodyStyle=null,this.savedParent=null,this.savedSize=null,this.expanderDiv=null,this.restoreSize=!1,this.onCloseHandlers=new Array,this.onResizeHandlers=new Array;var e=function(t,e){for(var i=0;i<e.length;++i)if(t[e[i]])return e[i];return null};this.requestFullScreen=e(t,["requestFullScreen","mozRequestFullScreen","webkitRequestFullScreen","msRequestFullscreen"]),this.cancelFullScreen=e(document,["cancelFullScreen","mozCancelFullScreen","webkitCancelFullScreen","msExitFullscreen"]),this.errorEvent="fullscreenerror",this.changeEvent="fullscreenchange";var i=this.requestFullScreen.substring(0,this.requestFullScreen.indexOf("Request"));""!==i&&(this.errorEvent=i+this.errorEvent,this.changeEvent=i+this.changeEvent,"ms"===i&&(this.errorEvent="MSFullscreenError",this.changeEvent="MSFullscreenChange")),this.restoreSize=null!=this.requestFullScreen},bigshot.FullScreen.prototype={browser:new bigshot.Browser,getRootElement:function(){return this.div},addOnClose:function(t){this.onCloseHandlers.push(t)},onClose:function(){for(var t=0;t<this.onCloseHandlers.length;++t)this.onCloseHandlers[t]()},addOnResize:function(t){this.onResizeHandlers.push(t)},onResize:function(){for(var t=0;t<this.onResizeHandlers.length;++t)this.onResizeHandlers[t]()},open:function(){return this.isFullScreen=!0,this.requestFullScreen?this.openRequestFullScreen():this.openCompat()},openRequestFullScreen:function(){this.savedSize={width:this.container.style.width,height:this.container.style.height},this.container.style.width="100%",this.container.style.height="100%";var t=this,e=function(){t.container.removeEventListener(t.errorEvent,e),t.isFullScreen=!1,t.exitFullScreenHandler(),t.onClose()};this.container.addEventListener(this.errorEvent,e);var i=function(){t.fullscreenElement=document.fullscreenElement||document.mozFullScreenElement||document.webkitCurrentFullScreenElement||document.msFullscreenElement,t.fullscreenElement!==t.container?(document.removeEventListener(t.changeEvent,i),t.container.removeEventListener(t.changeEvent,i),t.exitFullScreenHandler()):t.onResize()};document.addEventListener(this.changeEvent,i),this.container.addEventListener(this.changeEvent,i),this.exitFullScreenHandler=function(){t.isFullScreen&&(t.isFullScreen=!1,document[t.cancelFullScreen](),t.restoreSize&&(t.container.style.width=t.savedSize.width,t.container.style.height=t.savedSize.height),t.onResize(),t.onClose())},this.container[this.requestFullScreen]()},openCompat:function(){this.savedParent=this.container.parentNode,this.savedSize={width:this.container.style.width,height:this.container.style.height},this.savedBodyStyle=document.body.style.cssText,document.body.style.overflow="hidden",this.expanderDiv=document.createElement("div"),this.expanderDiv.style.position="absolute",this.expanderDiv.style.top="0px",this.expanderDiv.style.left="0px",this.expanderDiv.style.width=Math.max(window.innerWidth,document.documentElement.clientWidth)+"px",this.expanderDiv.style.height=Math.max(window.innerHeight,document.documentElement.clientHeight)+"px",document.body.appendChild(this.expanderDiv),this.div=document.createElement("div"),this.div.style.position="fixed",this.div.style.top=window.pageYOffset+"px",this.div.style.left=window.pageXOffset+"px",this.div.style.width=window.innerWidth+"px",this.div.style.height=window.innerHeight+"px",this.div.style.zIndex=9998,this.div.appendChild(this.container),document.body.appendChild(this.div);var t=this,e=function(){setTimeout(function(){t.div.style.width=window.innerWidth+"px",t.div.style.height=window.innerHeight+"px",setTimeout(function(){t.onResize()},1)},1)},i=function(){t.expanderDiv.style.width=Math.max(window.innerWidth,document.documentElement.clientWidth)+"px",t.expanderDiv.style.height=Math.max(window.innerHeight,document.documentElement.clientHeight)+"px",setTimeout(function(){t.div.style.top=window.pageYOffset+"px",t.div.style.left=window.pageXOffset+"px",t.div.style.width=window.innerWidth+"px",t.div.style.height=window.innerHeight+"px",setTimeout(function(){t.onResize()},1)},1)},s=function(e){27==e.keyCode&&t.exitFullScreenHandler()};return this.exitFullScreenHandler=function(){t.isFullScreen=!1,t.browser.unregisterListener(document,"keydown",s),t.browser.unregisterListener(window,"resize",e),t.browser.unregisterListener(document.body,"orientationchange",i),t.restoreSize&&(t.container.style.width=t.savedSize.width,t.container.style.height=t.savedSize.height),document.body.style.cssText=t.savedBodyStyle,t.savedParent.appendChild(t.container),document.body.removeChild(t.div),document.body.removeChild(t.expanderDiv),t.onResize(),t.onClose(),setTimeout(function(){t.onResize()},1)},this.browser.registerListener(document,"keydown",s,!1),this.browser.registerListener(window,"resize",e,!1),this.browser.registerListener(document.body,"orientationchange",i,!1),this.onResize(),this.exitFullScreenHandler},close:function(){this.exitFullScreenHandler()}},bigshot.DataLoader=function(){},bigshot.DataLoader.prototype={loadImage:function(){},loadXml:function(){}},bigshot.DefaultDataLoader=function(t,e){this.maxRetries=t,this.crossOrigin=e,this.maxRetries||(this.maxRetries=0)},bigshot.DefaultDataLoader.prototype={browser:new bigshot.Browser,loadImage:function(t,e){var i=document.createElement("img");i.retries=0,null!=this.crossOrigin&&(i.crossOrigin=this.crossOrigin);var s=this;return this.browser.registerListener(i,"load",function(){e&&e(i)},!1),this.browser.registerListener(i,"error",function(){i.retries++,i.retries<=s.maxRetries?setTimeout(function(){i.src=t},1e3*i.retries):e&&e(null)},!1),i.src=t,i},loadXml:function(t,e,i){for(var s=0;s<=this.maxRetries;++s){var r=this.browser.createXMLHttpRequest();if(r.open("GET",t,!1),r.send(null),200==r.status){var n=r.responseXML;if(null!=n)return i&&i(n),n}if(s==that.maxRetries)return i&&i(null),null}}},bigshot.Object.validate("bigshot.DefaultDataLoader",bigshot.DataLoader),bigshot.CachingDataLoader=function(){this.cache={},this.requested={},this.requestedTiles={}},bigshot.CachingDataLoader.prototype={browser:new bigshot.Browser,loadImage:function(t,e){if(this.cache[t])return e&&e(this.cache[t]),this.cache[t];if(this.requested[t])return e&&this.requested[t].push(e),this.requestedTiles[t];var i=this;this.requested[t]=new Array,e&&this.requested[t].push(e);var s=document.createElement("img");return this.requestedTiles[t]=s,this.browser.registerListener(s,"load",function(){var e=i.requested[t];delete i.requested[t],delete i.requestedTiles[t],i.cache[t]=s;for(var r=0;r<e.length;++r)e[r](s)},!1),s.src=t,s},loadXml:function(t,e,i){if(this.cache[t])return i&&i(this.cache[t]),this.cache[t];if(this.requested[t]&&e)i&&this.requested[t].push(i);else{var s=this.browser.createXMLHttpRequest();this.requested[t]||(this.requested[t]=new Array),e&&i&&this.requested[t].push(i);var r=this,n=function(){if(r.requested[t]){var e=null;200==s.status&&(e=s.responseXML);var i=r.requested[t];delete r.requested[t],r.cache[t]=e;for(var n=0;n<i.length;++n)i[n](e)}return e};if(!e)return s.open("GET",t,!1),s.send(),n();s.onreadystatechange=function(){4==s.readyState&&n()},s.open("GET",t,!0),s.send()}}},bigshot.Object.validate("bigshot.CachingDataLoader",bigshot.DataLoader),bigshot.Hotspot=function(t,e,i,s){var r=document.createElement("div");r.style.position="absolute",r.style.overflow="visible",this.element=r,this.x=t,this.y=e,this.w=i,this.h=s},bigshot.Hotspot.prototype={browser:new bigshot.Browser,layout:function(t,e,i){var s=this.x*i+t,r=this.y*i+e,n=this.w*i,a=this.h*i;this.element.style.top=r+"px",this.element.style.left=s+"px",this.element.style.width=n+"px",this.element.style.height=a+"px"},getElement:function(){return this.element}},bigshot.PointHotspot=function(t,e,i,s,r,n,a){if(bigshot.Hotspot.call(this,t,e,i,s),this.xo=r,this.yo=n,a){var h=this.getElement();h.style.backgroundImage="url('"+a+"')",h.style.backgroundRepeat="no-repeat"}},bigshot.PointHotspot.prototype={getLabel:function(){return this.label},layout:function(t,e,i){var s=this.x*i+t+this.xo,r=this.y*i+e+this.yo;this.element.style.top=r+"px",this.element.style.left=s+"px",this.element.style.width=this.w+"px",this.element.style.height=this.h+"px"}},bigshot.Object.extend(bigshot.PointHotspot,bigshot.Hotspot),bigshot.Layer=function(){},bigshot.Layer.prototype={getContainer:function(){},setMaxTiles:function(){},resize:function(){},layout:function(){}},bigshot.LabeledHotspot=function(t,e,i,s,r){bigshot.Hotspot.call(this,t,e,i,s),this.label=document.createElement("div"),this.label.style.position="relative",this.label.style.display="inline-block",this.getElement().appendChild(this.label),this.label.innerHTML=r,this.labelSize=this.browser.getElementSize(this.label)},bigshot.LabeledHotspot.prototype={getLabel:function(){return this.label},layout:function(t,e,i){this.layout._super.call(this,t,e,i);var s=this.w*i,r=this.h*i;this.label.style.top=r+4+"px",this.label.style.left=(s-this.labelSize.w)/2+"px"}},bigshot.Object.extend(bigshot.LabeledHotspot,bigshot.Hotspot),bigshot.LinkHotspot=function(t,e,i,s,r,n){bigshot.LabeledHotspot.call(this,t,e,i,s,r),this.browser.registerListener(this.getElement(),"click",function(){document.location.href=n})},bigshot.Object.extend(bigshot.LinkHotspot,bigshot.LabeledHotspot),bigshot.HotspotLayer=function(t){this.image=t,this.hotspots=new Array,this.browser=new bigshot.Browser,this.container=t.createLayerContainer(),this.parentContainer=t.getContainer(),this.resize(0,0)},bigshot.HotspotLayer.prototype={getContainer:function(){return this.container},resize:function(){this.container.style.width=this.parentContainer.clientWidth+"px",this.container.style.height=this.parentContainer.clientHeight+"px"},layout:function(t,e,i,s,r,n,a){var h=Math.pow(2,this.image.getZoom());e-=a*s,i-=a*r;for(var o=0;o<this.hotspots.length;++o)this.hotspots[o].layout(e,i,h)},setMaxTiles:function(){},addHotspot:function(t){this.container.appendChild(t.getElement()),this.hotspots.push(t)}},bigshot.Object.validate("bigshot.HotspotLayer",bigshot.Layer),bigshot.TileLayer=function(t,e,i,s,r){return this.rows=new Array,this.browser=new bigshot.Browser,this.container=t.createLayerContainer(),this.parentContainer=t.getContainer(),this.parameters=e,this.w=i,this.h=s,this.imageTileCache=r,this.resize(i,s),this},bigshot.TileLayer.prototype={getContainer:function(){return this.container},resize:function(t,e){this.container.style.width=this.parentContainer.clientWidth+"px",this.container.style.height=this.parentContainer.clientHeight+"px",this.pixelWidth=this.parentContainer.clientWidth,this.pixelHeight=this.parentContainer.clientHeight,this.w=t,this.h=e,this.rows=new Array,this.browser.removeAllChildren(this.container);for(var i=0;e>i;++i){for(var s=new Array,r=0;t>r;++r){var n=document.createElement("div");n.style.position="absolute",n.style.overflow="hidden",n.style.width=this.container.clientWidth+"px",n.style.height=this.container.clientHeight+"px";var a=document.createElement("div");a.style.position="relative",a.style.border="hidden",a.style.visibility="hidden",a.bigshotData={visible:!1},s.push(a),this.container.appendChild(n),n.appendChild(a)}this.rows.push(s)}},layout:function(t,e,i,s,r,n,a,h){t=Math.min(0,Math.ceil(t)),this.imageTileCache.resetUsed();for(var o=i,l=0,u=0;u<this.h;++u){for(var c=e,d=0;d<this.w;++d){var g=this.rows[u][d],m=g.bigshotData;if(0>c+n||c>this.pixelWidth||0>o+n||o>this.pixelHeight)m.visible&&(m.visible=!1,g.style.visibility="hidden");else{l++,g.style.left=c+"px",g.style.top=o+"px",g.style.width=n+"px",g.style.height=n+"px",g.style.opacity=h,m.visible||(m.visible=!0,g.style.visibility="visible");var p=d+s,f=u+r;this.parameters.wrapX&&(0>p||p>=this.imageTileCache.maxTileX)&&(p=(p+this.imageTileCache.maxTileX)%this.imageTileCache.maxTileX),this.parameters.wrapY&&(0>f||f>=this.imageTileCache.maxTileY)&&(f=(f+this.imageTileCache.maxTileY)%this.imageTileCache.maxTileY);var v=p+"_"+f+"_"+t,x=0>p||p>=this.imageTileCache.maxTileX||0>f||f>=this.imageTileCache.maxTileY;if(x){if(!m.isOutside){var b=this.imageTileCache.getImage(p,f,t);this.browser.removeAllChildren(g),g.appendChild(b),m.image=b}m.isOutside=!0,m.imageKey="EMPTY",m.image.style.width=n+"px",m.image.style.height=n+"px"}else{var b=this.imageTileCache.getImage(p,f,t);m.isOutside=!1,(m.imageKey!==v||m.isPartial)&&(this.browser.removeAllChildren(g),g.appendChild(b),m.image=b,m.imageKey=v,m.isPartial=b.isPartial),m.image.style.width=n+"px",m.image.style.height=n+"px"}}c+=a}o+=a}},setMaxTiles:function(t,e){this.imageTileCache.setMaxTiles(t,e)}},bigshot.Object.validate("bigshot.TileLayer",bigshot.Layer),bigshot.LRUMap=function(){this.keyToTime={},this.counter=0,this.size=0},bigshot.LRUMap.prototype={access:function(t){this.remove(t),this.keyToTime[t]=this.counter,++this.counter,++this.size},remove:function(t){return this.keyToTime[t]?(delete this.keyToTime[t],--this.size,!0):!1},getSize:function(){return this.size},leastUsed:function(){var t=this.counter+1,e=null;for(var i in this.keyToTime)this.keyToTime[i]<t&&(t=this.keyToTime[i],e=i);return e}},bigshot.ImageTileCache=function(t,e,i){var s=this;this.parameters=i,this.fullImage=null,i.dataLoader.loadImage(i.fileSystem.getPosterFilename(),function(t){s.fullImage=t,e&&e()}),this.maxCacheSize=512,this.maxTileX=0,this.maxTileY=0,this.cachedImages={},this.requestedImages={},this.usedImages={},this.lastOnLoadFiredAt=0,this.imageRequests=0,this.lruMap=new bigshot.LRUMap,this.onLoaded=t,this.browser=new bigshot.Browser,this.partialImageSize=i.tileSize/4,this.POSTER_ZOOM_LEVEL=Math.log(i.posterSize/Math.max(i.width,i.height))/Math.log(2)},bigshot.ImageTileCache.prototype={resetUsed:function(){this.usedImages={}},setMaxTiles:function(t,e){this.maxTileX=t,this.maxTileY=e},getPartialImage:function(t,e,i){var s=this.getPartialImageFromDownsampled(t,e,i,0,0,this.parameters.tileSize,this.parameters.tileSize);return null==s&&(s=this.getPartialImageFromPoster(t,e,i)),s},getPartialImageFromPoster:function(t,e,i){if(this.fullImage&&this.fullImage.complete){var s=this.fullImage.width/this.parameters.width,r=s*this.parameters.tileSize/Math.pow(2,i);return x0=Math.floor(r*t),y0=Math.floor(r*e),w=Math.floor(r),h=Math.floor(r),this.createPartialImage(this.fullImage,this.fullImage.width,x0,y0,w,h)}return null},createPartialImage:function(t,e,i,s,r,n){var a=document.createElement("canvas");if(!a.width)return null;a.width=this.partialImageSize,a.height=this.partialImageSize;var h=a.getContext("2d"),o=t.width/e,l=Math.floor(i*o),u=Math.floor(s*o),c=this.partialImageSize,d=this.partialImageSize;if(r*=o,l+r>=t.width){var g=r;r=t.width-l,c*=r/g}if(n*=o,u+n>=t.height){var m=n;n=t.height-u,d*=n/m}try{h.drawImage(t,l,u,r,n,-.1,-.1,c+.2,d+.2)}catch(p){return null}return a},getPartialImageFromDownsampled:function(t,e,i,s,r,n,a){if(i<this.POSTER_ZOOM_LEVEL||i<this.parameters.minZoom)return null;var h=this.getImageKey(t,e,i),o=this.cachedImages[h];return null==o&&this.requestImage(t,e,i),o?this.createPartialImage(o,this.parameters.tileSize,s,r,n,a):(n/=2,a/=2,s/=2,r/=2,t%2==1&&(s+=this.parameters.tileSize/2),e%2==1&&(r+=this.parameters.tileSize/2),t=Math.floor(t/2),e=Math.floor(e/2),--i,this.getPartialImageFromDownsampled(t,e,i,s,r,n,a))},getEmptyImage:function(){var t=document.createElement("img");return this.parameters.emptyImage?t.src=this.parameters.emptyImage:t.src="data:image/gif,GIF89a%01%00%01%00%80%00%00%00%00%00%FF%FF%FF!%F9%04%00%00%00%00%00%2C%00%00%00%00%01%00%01%00%00%02%02D%01%00%3B",t},getImage:function(t,e,i){if(0>t||0>e||t>=this.maxTileX||e>=this.maxTileY)return this.getEmptyImage();var s=this.getImageKey(t,e,i);if(this.lruMap.access(s),this.cachedImages[s]){if(this.usedImages[s]){var r=this.parameters.dataLoader.loadImage(this.getImageFilename(t,e,i));return r.isPartial=!1,r}this.usedImages[s]=!0;var n=this.cachedImages[s];return n}this.requestImage(t,e,i);var n=this.getPartialImage(t,e,i);return null!=n?(n.isPartial=!0,this.cachedImages[s]=n):(n=this.getEmptyImage(),null!=n&&(n.isPartial=!0)),n},requestImage:function(t,e,i){var s=this.getImageKey(t,e,i);if(!this.requestedImages[s]){this.imageRequests++;var r=this;this.requestedImages[s]=!0,this.parameters.dataLoader.loadImage(this.getImageFilename(t,e,i),function(t){delete r.requestedImages[s],r.imageRequests--,t.isPartial=!1,r.cachedImages[s]=t,r.fireOnLoad()})}},fireOnLoad:function(){var t=new Date;(0==this.imageRequests||t.getTime()>this.lastOnLoadFiredAt+50)&&(this.purgeCache(),this.lastOnLoadFiredAt=t.getTime(),this.onLoaded())},purgeCache:function(){for(var t=0;4>t;++t)if(this.lruMap.getSize()>this.maxCacheSize){var e=this.lruMap.leastUsed();this.lruMap.remove(e),delete this.cachedImages[e]}},getImageKey:function(t,e,i){return"I"+t+"_"+e+"_"+i},getImageFilename:function(t,e,i){var s=this.parameters.fileSystem.getImageFilename(t,e,i);return s}},bigshot.ImageParameters=function(t){if(this.posterSize=0,this.emptyImage=null,this.suffix=null,this.width=0,this.height=0,this.container=null,this.minZoom=0,this.maxZoom=0,this.tileSize=0,this.overlap=0,this.wrapX=!1,this.wrapY=!1,this.basePath=null,this.fileSystemType="folder",this.fileSystem=null,this.dataLoader=new bigshot.DefaultDataLoader,this.touchUI=!1,this.fling=!0,this.maxTextureMagnification=1,t)for(var e in t)this[e]=t[e];return this.merge=function(t,e){for(var i in t)(e||!this[i])&&(this[i]=t[i])},this},bigshot.ImageBase=function(t){bigshot.EventDispatcher.call(this),this.parameters=t,this.flying=0,this.container=t.container,this.x=t.width/2,this.y=t.height/2,this.zoom=0,this.width=t.width,this.height=t.height,this.minZoom=t.minZoom,this.maxZoom=t.maxZoom,this.tileSize=t.tileSize,this.overlap=0,this.imageTileCache=null,this.dragStart=null,this.dragged=!1,this.layers=new Array,this.fullScreenHandler=null,this.currentGesture=null;var e=this;this.onresizeHandler=function(){e.onresize()};var i=function(t){return t.preventDefault&&t.preventDefault(),!1},s=function(t){return t.clientX?t:{clientX:t.changedTouches[0].clientX,clientY:t.changedTouches[0].clientY,changedTouches:t.changedTouches}};this.setupLayers(),this.resize(),this.allListeners={DOMMouseScroll:function(t){return e.mouseWheel(t),i(t)},mousewheel:function(t){return e.mouseWheel(t),i(t)},dblclick:function(t){return e.mouseDoubleClick(t),i(t)},mousedown:function(t){return e.dragMouseDown(t),i(t)},gesturestart:function(t){return e.gestureStart(t),i(t)},gesturechange:function(t){return e.gestureChange(t),i(t)},gestureend:function(t){return e.gestureEnd(t),i(t)},touchstart:function(t){return e.dragMouseDown(s(t)),i(t)},mouseup:function(t){return e.dragMouseUp(t),i(t)},touchend:function(t){return e.dragMouseUp(s(t)),i(t)},mousemove:function(t){return e.dragMouseMove(t),i(t)},mouseout:function(t){return i(t)},touchmove:function(t){return e.dragMouseMove(s(t)),i(t)}},this.addEventListeners(),this.browser.registerListener(window,"resize",e.onresizeHandler,!1),this.zoomToFit()},bigshot.ImageBase.prototype={browser:new bigshot.Browser,addEventListeners:function(){for(var t in this.allListeners)this.browser.registerListener(this.container,t,this.allListeners[t],!1)},removeEventListeners:function(){for(var t in this.allListeners)this.browser.unregisterListener(this.container,t,this.allListeners[t],!1)},setupLayers:function(){},getTextureStretch:function(){var t=Math.log(this.parameters.maxTextureMagnification/this.browser.getDevicePixelScale())/Math.LN2;return t},clampXY:function(t,e){var i=this.container.clientWidth,s=this.container.clientHeight,r=Math.pow(2,this.zoom),n=i/r,a=s/r,h=function(t,e,i){var s=t/2;s=Math.min(e/2,s),s>i&&(i=s);var r=e-t/2;return r=Math.max(e/2,r),i>r&&(i=r),i},o={};return null!=t&&(o.x=h(n,this.width,t)),null!=e&&(o.y=h(a,this.height,e)),o},layout:function(){var t=this.container.clientWidth,e=this.container.clientHeight,i=Math.min(this.maxZoom,Math.max(this.zoom-this.getTextureStretch(),this.minZoom)),s=Math.min(0,Math.ceil(i)),r=Math.pow(2,s),n=this.clampXY(this.x,this.y);this.parameters.wrapY||(this.y=n.y),this.parameters.wrapX||(this.x=n.x);for(var a=this.tileSize/r,h=Math.pow(2,this.zoom-s),o=this.tileSize*h,l=(this.width/a,this.height/a,this.x/a),u=this.y/a,c=l-t/2/o,d=u-e/2/o,g=Math.floor(c),m=Math.floor(d),p=Math.round((c-g)*o),f=Math.round((d-m)*o),v=0;v<this.layers.length;++v)this.layers[v].layout(i,-p-o,-f-o,g-1,m-1,Math.ceil(o),Math.ceil(o),1)},resize:function(){for(var t=Math.ceil(2*this.container.clientWidth/this.tileSize)+2,e=Math.ceil(2*this.container.clientHeight/this.tileSize)+2,i=0;i<this.layers.length;++i)this.layers[i].resize(t,e)},createLayerContainer:function(){var t=document.createElement("div");return t.style.position="absolute",t.style.overflow="hidden",t},getContainer:function(){return this.container},addLayer:function(t){this.container.appendChild(t.getContainer()),this.layers.push(t)},clampZoom:function(t){return Math.min(this.maxZoom,Math.max(t,this.minZoom))},setZoom:function(t,e){this.zoom=this.clampZoom(t);for(var i=Math.ceil(this.zoom-this.getTextureStretch()),s=Math.pow(2,i),r=Math.ceil(s*this.width/this.tileSize),n=Math.ceil(s*this.height/this.tileSize),a=0;a<this.layers.length;++a)this.layers[a].setMaxTiles(r,n);e&&this.layout()},setMaxZoom:function(t){this.maxZoom=t},getMaxZoom:function(){return this.maxZoom},setMinZoom:function(t){this.minZoom=t},getMinZoom:function(){return this.minZoom},adjustCoordinateForZoom:function(t,e,i,s){var r=Math.pow(2,i)/Math.pow(2,s);return e+(t-e)*r},gestureStart:function(t){this.currentGesture={startZoom:this.zoom,scale:t.scale}},gestureEnd:function(){this.currentGesture=null,this.dragStart&&(this.dragStart.hadGesture=!0)},gestureChange:function(t){if(this.currentGesture){this.dragStart&&(this.dragStart.hadGesture=!0);var e=this.clampZoom(this.currentGesture.startZoom+Math.log(t.scale)/Math.log(2)),i=this.getZoom();if(void 0!==this.currentGesture.clientX&&void 0!==this.currentGesture.clientY){var s=this.clientToImage(this.currentGesture.clientX,this.currentGesture.clientY),r=this.adjustCoordinateForZoom(this.x,s.x,i,e),n=this.adjustCoordinateForZoom(this.y,s.y,i,e);this.moveTo(r,n,e)}else this.setZoom(e),this.layout()}},dragMouseDown:function(t){this.dragStart={x:t.clientX,y:t.clientY},this.dragLast={clientX:t.clientX,clientY:t.clientY,dx:0,dy:0,dt:1e6,time:(new Date).getTime()},this.dragged=!1},dragMouseMove:function(t){if(null!=this.currentGesture&&null!=t.changedTouches&&t.changedTouches.length>0){for(var e=0,i=0,s=0;s<t.changedTouches.length;++s)e+=t.changedTouches[s].clientX,i+=t.changedTouches[s].clientY;this.currentGesture.clientX=e/t.changedTouches.length,this.currentGesture.clientY=i/t.changedTouches.length}if(null==this.currentGesture&&null!=this.dragStart){var r={x:t.clientX-this.dragStart.x,y:t.clientY-this.dragStart.y};(0!=r.x||0!=r.y)&&(this.dragged=!0);var n=Math.pow(2,this.zoom),a=r.x/n,h=r.y/n;this.dragStart={x:t.clientX,y:t.clientY};var o=(new Date).getTime()-this.dragLast.time;o>20&&(this.dragLast={dx:this.dragLast.clientX-t.clientX,dy:this.dragLast.clientY-t.clientY,dt:o,clientX:t.clientX,clientY:t.clientY,time:(new Date).getTime()}),this.moveTo(this.x-a,this.y-h)}},dragMouseUp:function(t){if(null==this.currentGesture&&!this.dragStart.hadGesture&&null!=this.dragStart)if(this.dragStart=null,this.dragged){var e=Math.pow(2,this.zoom),i=this.dragLast.dx/e,s=this.dragLast.dy/e,r=Math.sqrt(i*i+s*s),n=this.dragLast.dt,a=(new Date).getTime()-this.dragLast.time;this.dragLast=null;var h=n>0?r/n:0;if(h>.05&&250>a&&n>20&&this.parameters.fling){(new Date).getTime();i/=n,s/=n,this.flyTo(this.x+250*i,this.y+250*s,this.zoom)}}else this.mouseClick(t)},mouseDoubleClick:function(t){var e=this.createImageEventData({type:"dblclick",clientX:t.clientX,clientY:t.clientY});this.fireEvent("dblclick",e),e.defaultPrevented||this.flyTo(e.imageX,e.imageY,this.zoom+.5)},getZoom:function(){return this.zoom},moveTo:function(t,e,i,s){this.stopFlying(),(null!=t||null!=e)&&this.setPosition(t,e,!1),null!=i&&this.setZoom(i,!1),(void 0==s||1==s)&&this.layout()},setPosition:function(t,e,i){var s=this.clampXY(t,e);null!=t&&(this.parameters.wrapX?(0>t||t>=this.width)&&(t=(t+this.width)%this.width):t=s.x,this.x=Math.max(0,Math.min(this.width,t))),null!=e&&(this.parameters.wrapY?(0>e||e>=this.height)&&(e=(e+this.height)%this.height):e=s.y,this.y=Math.max(0,Math.min(this.height,e))),0!=i&&this.layout()},fitZoom:function(t,e){var i=e/t;return Math.log(i)/Math.LN2},getZoomToFitValue:function(){return Math.min(this.fitZoom(this.parameters.width,this.container.clientWidth),this.fitZoom(this.parameters.height,this.container.clientHeight))},getZoomToFillValue:function(){return Math.max(this.fitZoom(this.parameters.width,this.container.clientWidth),this.fitZoom(this.parameters.height,this.container.clientHeight))},zoomToFit:function(){this.moveTo(null,null,this.getZoomToFitValue())},zoomToFill:function(){this.moveTo(null,null,this.getZoomToFillValue())},zoomToFitHeight:function(){this.moveTo(null,null,this.fitZoom(this.parameters.height,this.container.clientHeight))},zoomToFitWidth:function(){this.moveTo(null,null,this.fitZoom(this.parameters.width,this.container.clientWidth))},flyZoomToFitHeight:function(){this.flyTo(null,this.parameters.height/2,this.fitZoom(this.parameters.height,this.container.clientHeight))},flyZoomToFitWidth:function(){this.flyTo(this.parameters.width/2,null,this.fitZoom(this.parameters.width,this.container.clientWidth))},flyZoomToFit:function(){this.flyTo(this.parameters.width/2,this.parameters.height/2,this.getZoomToFitValue())},clientToImage:function(t,e){var i=Math.pow(2,this.zoom);return{x:(t-this.container.clientWidth/2)/i+this.x,y:(e-this.container.clientHeight/2)/i+this.y}},mouseWheelHandler:function(t,e){var i=!1;if(t>0?i=.5:0>t&&(i=-.5),i){var s=this.clientToImage(e.clientX,e.clientY),r=Math.min(this.maxZoom,Math.max(this.getZoom()+i,this.minZoom)),n=this.adjustCoordinateForZoom(this.x,s.x,this.getZoom(),r),a=this.adjustCoordinateForZoom(this.y,s.y,this.getZoom(),r);this.flyTo(n,a,r,!0)}},mouseWheel:function(t){var e=0;t||(t=window.event),t.wheelDelta?(e=t.wheelDelta/120,window.opera&&(e=-e)):t.detail&&(e=-t.detail),e&&this.mouseWheelHandler(e,t),t.preventDefault&&t.preventDefault(),t.returnValue=!1},onresize:function(){this.resize(),this.layout()},getX:function(){return this.x},getY:function(){return this.y},stopFlying:function(){this.flying++},flyTo:function(t,e,i,s){var r=this;t=null!=t?t:this.x,e=null!=e?e:this.y,i=null!=i?i:this.zoom,s=null!=s?s:!1;var n=this.x,a=this.y,h=this.zoom,o=this.clampXY(t,e),l=this.parameters.wrapX?t:o.x,u=this.parameters.wrapY?e:o.y,c=Math.min(this.maxZoom,Math.max(i,this.minZoom));this.flying++;var d=this.flying,g=(new Date).getTime(),m=function(t,e,i,s,r){var n=e-t,a=-n*Math.pow(2,-i*s),h=i*r;return a=0>n?Math.max(0,a-h):Math.min(0,a+h),e+a},p=function(){if(r.flying==d){var t=((new Date).getTime()-g)/1e3,e=m(n,l,t,s?10:4,s?.2:1),i=m(a,u,t,s?10:4,s?.2:1),o=m(h,c,t,10,.2),f=!0,v=Math.min(Math.pow(2,r.getZoom()),1);Math.abs(e-l)<.5*v?e=l:f=!1,Math.abs(i-u)<.5*v?i=u:f=!1,Math.abs(o-c)<.02?o=c:f=!1,r.setPosition(e,i,!1),r.setZoom(o,!1),r.layout(),f||r.browser.requestAnimationFrame(p,r.container)}};this.browser.requestAnimationFrame(p,this.container)},rectVisibleAtZoomLevel:function(t,e){return Math.min(this.fitZoom(t,this.container.clientWidth),this.fitZoom(e,this.container.clientHeight))},getTouchAreaBaseSize:function(){var t=(this.container.clientWidth+this.container.clientHeight)/2*.2;return Math.min(t,Math.min(this.container.clientWidth,this.container.clientHeight)/6)},createImageEventData:function(t){var e=this.browser.getElementPosition(this.container);t.localX=t.clientX-e.x,t.localY=t.clientY-e.y;var i=Math.pow(2,this.zoom);return t.imageX=(t.localX-this.container.clientWidth/2)/i+this.x,t.imageY=(t.localY-this.container.clientHeight/2)/i+this.y,t.target=this,t.currentTarget=this,new bigshot.ImageEvent(t)},mouseClick:function(t){var e=this.createImageEventData({type:"click",clientX:t.clientX,clientY:t.clientY});this.fireEvent("click",e)},showTouchUI:function(t,e){t||(t=2500),e||(e=1e3);var i=this.getTouchAreaBaseSize(),s=this.getTouchAreaBaseSize(),r=this.container.clientWidth/2,n=this.container.clientHeight/2,a=document.createElement("div");a.style.position="absolute",a.style.zIndex="9999",a.style.opacity=.9,a.style.width=this.container.clientWidth+"px",a.style.height=this.container.clientHeight+"px";var h=document.createElement("div");h.style.position="absolute";var o=document.createElement("div");o.style.position="relative",o.style.background="black",o.style.textAlign="center",o.style.top=n-s+"px",o.style.left=r-s+"px",o.style.width=2*s+"px",o.style.height=2*s+"px",a.appendChild(h),h.appendChild(o),o.innerHTML="<span style='display:inline-box; position:relative; vertical-align:middle; font-size: 20pt; top: 10pt; color:white'>ZOOM IN</span>";var l=document.createElement("div");l.style.position="absolute";var u=document.createElement("div");u.style.position="relative",u.style.border=i+"px solid black",u.style.top="0px",u.style.left="0px",u.style.textAlign="center",u.style.width=this.container.clientWidth+"px",u.style.height=this.container.clientHeight+"px",u.style.MozBoxSizing=u.style.boxSizing=u.style.WebkitBoxSizing="border-box",u.innerHTML="<span style='position:relative; font-size: 20pt; top: -25pt; color:white'>ZOOM OUT</span>",l.appendChild(u),a.appendChild(l),this.container.appendChild(a);var c=this,d=.9,g=e/50;1>g&&(g=1);var m=function(){d-=.9/g,0>d?c.container.removeChild(a):(a.style.opacity=d,setTimeout(m,50))};setTimeout(m,t)},exitFullScreen:function(){return this.fullScreenHandler?(this.removeEventListeners(),this.fullScreenHandler.close(),this.addEventListeners(),void(this.fullScreenHandler=null)):void 0},fullScreen:function(t){if(!this.fullScreenHandler){var e=document.createElement("div");e.style.position="absolute",e.style.fontSize="16pt",e.style.top="128px",e.style.width="100%",e.style.color="white",e.style.padding="16px",e.style.zIndex="9999",e.style.textAlign="center",e.style.opacity="0.75",e.innerHTML="<span style='border-radius: 16px; -moz-border-radius: 16px; padding: 16px; padding-left: 32px; padding-right: 32px; background:black'>Press Esc to exit full screen mode.</span>";var i=this;return this.fullScreenHandler=new bigshot.FullScreen(this.container),this.fullScreenHandler.restoreSize=!0,this.fullScreenHandler.addOnResize(function(){i.fullScreenHandler&&i.fullScreenHandler.isFullScreen&&(i.container.style.width=window.innerWidth+"px",i.container.style.height=window.innerHeight+"px"),i.onresize()}),this.fullScreenHandler.addOnClose(function(){if(e.parentNode)try{div.removeChild(e)}catch(t){}i.fullScreenHandler=null}),t&&this.fullScreenHandler.addOnClose(function(){t()}),this.removeEventListeners(),this.fullScreenHandler.open(),this.addEventListeners(),this.fullScreenHandler.getRootElement()&&(this.fullScreenHandler.getRootElement().appendChild(e),setTimeout(function(){var t=.75,i=function(){if(t-=.02,e.parentNode)if(0>=t)try{div.removeChild(e)}catch(s){}else e.style.opacity=t,setTimeout(i,20)};setTimeout(i,20)},3500)),function(){i.fullScreenHandler.close()}}},dispose:function(){this.browser.unregisterListener(window,"resize",this.onresizeHandler,!1),this.removeEventListeners()}},bigshot.Object.extend(bigshot.ImageBase,bigshot.EventDispatcher),bigshot.Image=function(t){bigshot.setupFileSystem(t),t.merge(t.fileSystem.getDescriptor(),!1),bigshot.ImageBase.call(this,t)},bigshot.Image.prototype={setupLayers:function(){var t=this;this.thisTileCache=new bigshot.ImageTileCache(function(){t.layout()},null,this.parameters),this.addLayer(new bigshot.TileLayer(this,this.parameters,0,0,this.thisTileCache))}},bigshot.Object.extend(bigshot.Image,bigshot.ImageBase),bigshot.HTMLElementLayer=function(t,e,i,s){this.hotspots=new Array,this.browser=new bigshot.Browser,this.image=t,this.container=t.createLayerContainer(),this.parentContainer=t.getContainer(),this.element=e,this.parentContainer.appendChild(e),this.w=i,this.h=s,this.resize(0,0)},bigshot.HTMLElementLayer.prototype={getContainer:function(){return this.container},resize:function(){this.container.style.width=this.parentContainer.clientWidth+"px",this.container.style.height=this.parentContainer.clientHeight+"px"},layout:function(t,e,i,s,r,n,a){var h=Math.pow(2,this.image.getZoom());e-=a*s,i-=a*r,this.element.style.top=i+"px",this.element.style.left=e+"px",this.element.style.width=this.w*h+"px",this.element.style.height=this.h*h+"px"},setMaxTiles:function(){}},bigshot.Object.validate("bigshot.HTMLElementLayer",bigshot.Layer),bigshot.HTMLDivElementLayer=function(t,e,i,s,r,n){this.wrapX=r,this.wrapY=n,this.hotspots=new Array,this.browser=new bigshot.Browser,this.image=t,this.container=t.createLayerContainer(),this.parentContainer=t.getContainer(),this.element=e,this.parentContainer.appendChild(e),this.w=i,this.h=s,this.resize(0,0)},bigshot.HTMLDivElementLayer.prototype={getContainer:function(){return this.container},resize:function(){this.container.style.width=this.parentContainer.clientWidth+"px",this.container.style.height=this.parentContainer.clientHeight+"px"},layout:function(t,e,i,s,r,n,a){var h=Math.pow(2,this.image.getZoom());e-=a*s,i-=a*r;var o=this.w*h,l=this.h*h;this.element.style.backgroundSize=o+"px "+l+"px";var u="0px",c="0px";this.wrapY?(this.element.style.top="0px",this.element.style.height=this.parentContainer.clientHeight+"px",c=i+"px"):(this.element.style.top=i+"px",this.element.style.height=l+"px"),this.wrapX?(this.element.style.left="0px",this.element.style.width=this.parentContainer.clientWidth+"px",u=e+"px"):(this.element.style.left=e+"px",this.element.style.width=o+"px"),this.element.style.backgroundPosition=u+" "+c},setMaxTiles:function(){}},bigshot.Object.validate("bigshot.HTMLDivElementLayer",bigshot.Layer),bigshot.SimpleImage=function(t,e){if(t.merge({fileSystem:null,fileSystemType:"simple",maxTextureMagnification:1,tileSize:1024},!0),e)t.merge({width:e.width,height:e.height}),this.imgElement=e;else if(0==t.width||0==t.height)throw new Error("No imgElement and missing width or height in ImageParameters");bigshot.setupFileSystem(t),bigshot.ImageBase.call(this,t)},bigshot.SimpleImage.prototype={setupLayers:function(){this.imgElement||(this.imgElement=document.createElement("div"),this.imgElement.style.backgroundImage="url('"+this.parameters.basePath+"')",this.imgElement.style.position="absolute",this.parameters.wrapX||this.parameters.wrapY?this.parameters.wrapX&&!this.parameters.wrapY?this.imgElement.style.backgroundRepeat="repeat-x":!this.parameters.wrapX&&this.parameters.wrapY?this.imgElement.style.backgroundRepeat="repeat-y":this.parameters.wrapX&&this.parameters.wrapY&&(this.imgElement.style.backgroundRepeat="repeat"):this.imgElement.style.backgroundRepeat="no-repeat"),this.addLayer(new bigshot.HTMLDivElementLayer(this,this.imgElement,this.parameters.width,this.parameters.height,this.parameters.wrapX,this.parameters.wrapY))}},bigshot.Object.extend(bigshot.SimpleImage,bigshot.ImageBase),bigshot.FileSystem=function(){},bigshot.FileSystem.prototype={getFilename:function(){},getImageFilename:function(){},setPrefix:function(){},getDescriptor:function(){},getPosterFilename:function(){}},bigshot.setupFileSystem=function(t){t.fileSystem||("archive"==t.fileSystemType?t.fileSystem=new bigshot.ArchiveFileSystem(t):"dzi"==t.fileSystemType?t.fileSystem=new bigshot.DeepZoomImageFileSystem(t):"simple"==t.fileSystemType?t.fileSystem=new bigshot.SimpleFileSystem(t):t.fileSystem=new bigshot.FolderFileSystem(t))},bigshot.SimpleFileSystem=function(t){this.parameters=t},bigshot.SimpleFileSystem.prototype={getDescriptor:function(){return{}},getPosterFilename:function(){return null},getFilename:function(){return null},getImageFilename:function(){return null},getPrefix:function(){return""},setPrefix:function(t){this.prefix=t}},bigshot.Object.validate("bigshot.SimpleFileSystem",bigshot.FileSystem),bigshot.FolderFileSystem=function(t){this.prefix=null,this.suffix="",this.parameters=t},bigshot.FolderFileSystem.prototype={getDescriptor:function(){this.browser=new bigshot.Browser;var t=this.browser.createXMLHttpRequest();t.open("GET",this.getFilename("descriptor"),!1),t.send(null);var e={};if(200==t.status){for(var i=t.responseText.split(":"),s=0;s<i.length;s+=2)"suffix"==i[s]?e[i[s]]=i[s+1]:e[i[s]]=parseInt(i[s+1]);return this.suffix=e.suffix,e}throw new Error("Unable to find descriptor.")},getPosterFilename:function(){return this.getFilename("poster"+this.suffix)},setPrefix:function(t){this.prefix=t},getPrefix:function(){return this.prefix?this.prefix+"/":""},getFilename:function(t){return this.parameters.basePath+"/"+this.getPrefix()+t},getImageFilename:function(t,e,i){var s=-i+"/"+t+"_"+e+this.suffix;return this.getFilename(s)}},bigshot.Object.validate("bigshot.FolderFileSystem",bigshot.FileSystem),bigshot.DeepZoomImageFileSystem=function(t){this.prefix="",this.suffix="",this.DZ_NAMESPACE="http://schemas.microsoft.com/deepzoom/2009",this.fullZoomLevel=0,this.posterName="",this.parameters=t},bigshot.DeepZoomImageFileSystem.prototype={getDescriptor:function(){var t={},e=this.parameters.dataLoader.loadXml(this.parameters.basePath+this.prefix+".xml",!1),i=e.getElementsByTagName("Image")[0],s=e.getElementsByTagName("Size")[0];t.width=parseInt(s.getAttribute("Width")),t.height=parseInt(s.getAttribute("Height")),t.tileSize=parseInt(i.getAttribute("TileSize")),t.overlap=parseInt(i.getAttribute("Overlap")),t.suffix="."+i.getAttribute("Format"),t.posterSize=t.tileSize,this.suffix=t.suffix,this.fullZoomLevel=Math.ceil(Math.log(Math.max(t.width,t.height))/Math.LN2),t.minZoom=-this.fullZoomLevel;var r=Math.ceil(Math.log(t.tileSize)/Math.LN2);return this.posterName=this.getImageFilename(0,0,r-this.fullZoomLevel),t},setPrefix:function(t){this.prefix=t},getPosterFilename:function(){return this.posterName},getFilename:function(t){return this.parameters.basePath+this.prefix+"/"+t},getImageFilename:function(t,e,i){var s=this.fullZoomLevel+i,r=s+"/"+t+"_"+e+this.suffix;return this.getFilename(r)}},bigshot.ArchiveFileSystem=function(t){this.indexSize=0,this.offset=0,this.index={},this.prefix="",this.suffix="",this.parameters=t;var e=new bigshot.Browser,i=e.createXMLHttpRequest();if(i.open("GET",this.parameters.basePath+"&start=0&length=24&type=text/plain",!1),i.send(null),200==i.status){if("BIGSHOT"!=i.responseText.substring(0,7))return void alert('"'+this.parameters.basePath+'" is not a valid bigshot file');if(this.indexSize=parseInt(i.responseText.substring(8),16),this.offset=this.indexSize+24,i.open("GET",this.parameters.basePath+"&type=text/plain&start=24&length="+this.indexSize,!1),i.send(null),200==i.status)for(var s=i.responseText.split(":"),r=0;r<s.length;r+=3)this.index[s[r]]={start:parseInt(s[r+1])+this.offset,length:parseInt(s[r+2])};else alert('The index of "'+this.parameters.basePath+'" could not be loaded: '+i.status)}else alert('The header of "'+this.parameters.basePath+'" could not be loaded: '+i.status)},bigshot.ArchiveFileSystem.prototype={getDescriptor:function(){this.browser=new bigshot.Browser;var t=this.browser.createXMLHttpRequest();t.open("GET",this.getFilename("descriptor"),!1),t.send(null);var e={};if(200==t.status){for(var i=t.responseText.split(":"),s=0;s<i.length;s+=2)"suffix"==i[s]?e[i[s]]=i[s+1]:e[i[s]]=parseInt(i[s+1]);return this.suffix=e.suffix,e}throw new Error("Unable to find descriptor.")},getPosterFilename:function(){return this.getFilename("poster"+this.suffix)},getFilename:function(t){t=this.getPrefix()+t,!this.index[t]&&console&&console.log("Can't find "+t);var e=this.parameters.basePath+"&start="+this.index[t].start+"&length="+this.index[t].length;return e+=".jpg"==t.substring(t.length-4)?"&type=image/jpeg":".png"==t.substring(t.length-4)?"&type=image/png":"&type=text/plain"},getImageFilename:function(t,e,i){var s=-i+"/"+t+"_"+e+this.suffix;return this.getFilename(s)},getPrefix:function(){return this.prefix?this.prefix+"/":""},setPrefix:function(t){this.prefix=t}},bigshot.Object.validate("bigshot.ArchiveFileSystem",bigshot.FileSystem),bigshot.VRTileCache=function(){},bigshot.VRTileCache.prototype={getTexture:function(){},purge:function(){},dispose:function(){}},bigshot.ImageVRTileCache=function(t,e,i){this.imageTileCache=new bigshot.ImageTileCache(t,e,i),this.imageTileCache.setMaxTiles(999999,999999)},bigshot.ImageVRTileCache.prototype={getTexture:function(t,e,i){var s=this.imageTileCache.getImage(t,e,i);return s},purge:function(){this.imageTileCache.resetUsed()},dispose:function(){}},bigshot.Object.validate("bigshot.ImageVRTileCache",bigshot.VRTileCache),bigshot.TextureTileCache=function(t,e,i,s){this.parameters=i,this.webGl=s,this.fullImage=i.dataLoader.loadImage(i.fileSystem.getPosterFilename(),e),this.maxTextureCacheSize=512,this.maxImageCacheSize=2048,this.cachedTextures={},this.cachedImages={},this.requestedImages={},this.lastOnLoadFiredAt=0,this.imageRequests=0,this.partialImageSize=i.tileSize/8,this.imageLruMap=new bigshot.LRUMap,this.textureLruMap=new bigshot.LRUMap,this.onLoaded=t,this.browser=new bigshot.Browser,this.disposed=!1},bigshot.TextureTileCache.prototype={getPartialTexture:function(t,e,i){if(this.fullImage.complete){var s=document.createElement("canvas");if(!s.width)return null;s.width=this.partialImageSize,s.height=this.partialImageSize;var r=s.getContext("2d"),n=this.parameters.posterSize/Math.max(this.parameters.width,this.parameters.height),a=Math.floor(n*this.parameters.width),h=Math.floor(n*this.parameters.height),o=n*(this.parameters.tileSize-this.parameters.overlap)/Math.pow(2,i),l=Math.floor(o*t),u=Math.floor(o*e),c=Math.floor(o),d=Math.floor(o),g=this.partialImageSize+2,m=this.partialImageSize+2;return l+c>a&&(c=a-l,g=this.partialImageSize*(c/Math.floor(o))),u+d>h&&(d=h-u,m=this.partialImageSize*(d/Math.floor(o))),r.drawImage(this.fullImage,l,u,c,d,-1,-1,g,m),this.webGl.createImageTextureFromImage(s,this.parameters.textureMinFilter,this.parameters.textureMagFilter)}return null},setCachedTexture:function(t,e){null!=this.cachedTextures[t]&&this.webGl.deleteTexture(this.cachedTextures[t]),this.cachedTextures[t]=e},getTexture:function(t,e,i){var s=this.getImageKey(t,e,i);if(this.textureLruMap.access(s),this.imageLruMap.access(s),this.cachedTextures[s])return this.cachedTextures[s];if(this.cachedImages[s])return this.setCachedTexture(s,this.webGl.createImageTextureFromImage(this.cachedImages[s],this.parameters.textureMinFilter,this.parameters.textureMagFilter)),this.cachedTextures[s];this.requestImage(t,e,i);var r=this.getPartialTexture(t,e,i);return r&&this.setCachedTexture(s,r),r},requestImage:function(t,e,i){var s=this.getImageKey(t,e,i);if(!this.requestedImages[s]){this.imageRequests++;var r=this;this.parameters.dataLoader.loadImage(this.getImageFilename(t,e,i),function(t){if(!r.disposed){r.cachedImages[s]=t,r.setCachedTexture(s,r.webGl.createImageTextureFromImage(t,r.parameters.textureMinFilter,r.parameters.textureMagFilter)),delete r.requestedImages[s],r.imageRequests--;var e=new Date;(0==r.imageRequests||e.getTime()>r.lastOnLoadFiredAt+50)&&(r.lastOnLoadFiredAt=e.getTime(),r.onLoaded())}}),this.requestedImages[s]=!0}},purge:function(){var t=this;this.purgeCache(this.textureLruMap,this.cachedTextures,this.maxTextureCacheSize,function(e){t.webGl.deleteTexture(t.cachedTextures[e])}),this.purgeCache(this.imageLruMap,this.cachedImages,this.maxImageCacheSize,function(){})},purgeCache:function(t,e,i,s){for(var r=0;64>r&&t.getSize()>i;++r){var n=t.leastUsed();t.remove(n),s&&s(n),delete e[n]}},getImageKey:function(t,e,i){return"I"+t+"_"+e+"_"+i},getImageFilename:function(t,e,i){var s=this.parameters.fileSystem.getImageFilename(t,e,i);return s},dispose:function(){this.disposed=!0;for(var t in this.cachedTextures)this.webGl.deleteTexture(this.cachedTextures[t])}},bigshot.Object.validate("bigshot.TextureTileCache",bigshot.VRTileCache),bigshot.VRFace=function(t,e,i,s,r,n,a){var h=this;this.owner=t,this.key=e,this.topLeft=i,this.width=s,this.u=r,this.v=n,this.updated=!1,this.parameters=new Object;for(var o in this.owner.getParameters())this.parameters[o]=this.owner.getParameters()[o];bigshot.setupFileSystem(this.parameters),this.parameters.fileSystem.setPrefix("face_"+e),this.parameters.merge(this.parameters.fileSystem.getDescriptor(),!1),this.tileCache=t.renderer.createTileCache(function(){h.updated=!0,t.renderUpdated(bigshot.VRPanorama.ONRENDER_TEXTURE_UPDATE)},a,this.parameters),this.fullSize=this.parameters.width,this.overlap=this.parameters.overlap,this.tileSize=this.parameters.tileSize,this.minDivisions=0;var l=Math.log(this.fullSize-this.overlap)/Math.LN2,u=Math.log(this.tileSize-this.overlap)/Math.LN2;this.maxDivisions=Math.floor(l-u),this.maxTesselation=this.parameters.maxTesselation>=0?this.parameters.maxTesselation:this.maxDivisions},bigshot.VRFace.prototype={browser:new bigshot.Browser,dispose:function(){this.tileCache.dispose()},pt3dMultAdd:function(t,e,i){return{x:t.x*e+i.x,y:t.y*e+i.y,z:t.z*e+i.z}},pt3dMult:function(t,e){return{x:t.x*e,y:t.y*e,z:t.z*e}},generateFace:function(t,e,i,s,r,n){i*=this.tileSize/(this.tileSize-this.overlap);var a=this.tileCache.getTexture(s,r,-this.maxDivisions+n);t.addQuad(this.owner.renderer.createTexturedQuad(e,this.pt3dMult(this.u,i),this.pt3dMult(this.v,i),a))},VISIBLE_NONE:0,VISIBLE_SOME:1,VISIBLE_ALL:2,pointInRect:function(t,e,i){return t.x>=e.x&&t.y>=e.y&&t.x<i.x&&t.y<i.y},intersectWithView:function(t){for(var e=0,i=[],s=t.length,r=0;s>r;++r)null==t[r]?e++:i.push(t[r]);if(4==e)return this.VISIBLE_NONE;for(var n=i[0].x,a=i[0].y,h=n,o=a,l=0,u=0,c=this.viewportWidth,d=this.viewportHeight,g=i.length,r=1;g>r;++r){var m=i[r].x,p=i[r].y;n=m>n?n:m,a=p>a?a:p,h=h>m?h:m,o=o>p?o:p}var f=n>l?n:l,v=a>u?a:u,x=c>h?h:c,b=d>o?o:d;return x>=f&&b>=v?this.VISIBLE_SOME:this.VISIBLE_NONE},screenDistance:function(t,e){return null==t||null==e?0:Math.max(Math.abs(t.x-e.x),Math.abs(t.y-e.y))},transformToScreen:function(t){return this.owner.renderer.transformToScreen(t)},generateSubdivisionFace:function(t,e,i,s,r,n,a){if(!a){a=new Array(4),a[0]=this.transformToScreen(e);var h=this.pt3dMultAdd(this.u,i,e);a[1]=this.transformToScreen(h);var o=this.pt3dMultAdd(this.v,i,e);a[3]=this.transformToScreen(o);var l=this.pt3dMultAdd(this.v,i,h);a[2]=this.transformToScreen(l)}var u=this.intersectWithView(a);if(u!=this.VISIBLE_NONE){for(var c=0,d=0;d<a.length;++d){var g=(d+1)%4;c=Math.max(this.screenDistance(a[d],a[g]),c)}if(c*=this.owner.browser.getDevicePixelScale(),s<this.minDivisions||c>this.owner.maxTextureMagnification*(this.tileSize-this.overlap)&&s<this.maxDivisions&&s<this.maxTesselation){var m=this.pt3dMultAdd({x:this.u.x+this.v.x,y:this.u.y+this.v.y,z:this.u.z+this.v.z},i/2,e),p=this.pt3dMultAdd(this.u,i/2,e),f=this.pt3dMultAdd(this.v,i/2,e),v=this.transformToScreen(m),x=this.transformToScreen(f),b=this.transformToScreen(p),y=this.transformToScreen(this.pt3dMultAdd(this.u,i,f)),w=this.transformToScreen(this.pt3dMultAdd(this.v,i,p));this.generateSubdivisionFace(t,e,i/2,s+1,2*r,2*n,[a[0],b,v,x]),this.generateSubdivisionFace(t,p,i/2,s+1,2*r+1,2*n,[b,a[1],y,v]),this.generateSubdivisionFace(t,f,i/2,s+1,2*r,2*n+1,[x,v,w,a[3]]),this.generateSubdivisionFace(t,m,i/2,s+1,2*r+1,2*n+1,[v,y,a[2],w])}else this.generateFace(t,e,i,r,n,s)}},isUpdated:function(){return this.updated},render:function(t){this.updated=!1,this.viewportWidth=this.owner.renderer.getViewportWidth(),this.viewportHeight=this.owner.renderer.getViewportHeight(),this.generateSubdivisionFace(t,this.topLeft,this.width,0,0,0)},endRender:function(){this.tileCache.purge()}},bigshot.WebGLUtil={debug:!1,contextNames:["webgl","experimental-webgl"],createContext0:function(t,e){var i=this.debug?WebGLDebugUtils.makeDebugContext(t.getContext(e)):t.getContext(e);return i},createContext:function(t){for(var e=0;e<this.contextNames.length;++e)try{var i=this.createContext0(t,this.contextNames[e]);if(i)return i}catch(s){}throw new Error("Could not initialize WebGL.")},isWebGLSupported:function(){var t=document.createElement("canvas");if(!t.width)return!1;try{return this.createContext(t),!0}catch(e){return!1}}},bigshot.TransformStack=function(){this.mvMatrix=null,this.mvMatrixStack=[],this.reset()},bigshot.TransformStack.prototype={push:function(t){return t?(this.mvMatrixStack.push(t.dup()),this.mvMatrix=t.dup(),mvMatrix):(this.mvMatrixStack.push(this.mvMatrix.dup()),mvMatrix)},pop:function(){if(0==this.mvMatrixStack.length)throw new Error("Invalid popMatrix!");return this.mvMatrix=this.mvMatrixStack.pop(),mvMatrix},reset:function(){this.mvMatrix=Matrix.I(4)},multiply:function(t){this.mvMatrix=t.x(this.mvMatrix)},translate:function(t){var e=Matrix.Translation($V([t.x,t.y,t.z])).ensure4x4();this.multiply(e)},rotate:function(t,e){var i=t*Math.PI/180,s=Matrix.Rotation(i,$V([e.x,e.y,e.z])).ensure4x4();this.multiply(s)},rotateX:function(t){this.rotate(t,{x:1,y:0,z:0})},rotateY:function(t){this.rotate(t,{x:0,y:1,z:0})},rotateZ:function(t){this.rotate(t,{x:0,y:0,z:1})},perspective:function(t,e,i,s){var r=makePerspective(t,e,i,s);this.multiply(r)},matrix:function(){return this.mvMatrix}},bigshot.WebGL=function(t){this.canvas=t,this.gl=bigshot.WebGLUtil.createContext(this.canvas),this.mvMatrix=new bigshot.TransformStack,this.pMatrix=new bigshot.TransformStack,this.shaderProgram=null,this.onresize()},bigshot.WebGL.prototype={onresize:function(){this.gl.viewportWidth=this.canvas.width,this.gl.viewportHeight=this.canvas.height},fragmentShader:"#ifdef GL_ES\n    precision highp float;\n#endif\n\nvarying vec2 vTextureCoord;\n\nuniform sampler2D uSampler;\n\nvoid main(void) {\n    gl_FragColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));\n}\n",vertexShader:"attribute vec3 aVertexPosition;\nattribute vec2 aTextureCoord;\n\nuniform mat4 uMVMatrix;\nuniform mat4 uPMatrix;\n\nvarying vec2 vTextureCoord;\n\nvoid main(void) {\n    gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);\n    vTextureCoord = aTextureCoord;\n}",createShader:function(t,e){var i=this.gl.createShader(e);return this.gl.shaderSource(i,t),this.gl.compileShader(i),this.gl.getShaderParameter(i,this.gl.COMPILE_STATUS)?i:(alert(this.gl.getShaderInfoLog(i)),null)},createFragmentShader:function(t){return this.createShader(t,this.gl.FRAGMENT_SHADER)},createVertexShader:function(t){return this.createShader(t,this.gl.VERTEX_SHADER)},initShaders:function(){if(this.shaderProgram=this.gl.createProgram(),this.gl.attachShader(this.shaderProgram,this.createVertexShader(this.vertexShader)),this.gl.attachShader(this.shaderProgram,this.createFragmentShader(this.fragmentShader)),this.gl.linkProgram(this.shaderProgram),!this.gl.getProgramParameter(this.shaderProgram,this.gl.LINK_STATUS))throw new Error("Could not initialise shaders");this.gl.useProgram(this.shaderProgram),this.shaderProgram.vertexPositionAttribute=this.gl.getAttribLocation(this.shaderProgram,"aVertexPosition"),this.gl.enableVertexAttribArray(this.shaderProgram.vertexPositionAttribute),this.shaderProgram.textureCoordAttribute=this.gl.getAttribLocation(this.shaderProgram,"aTextureCoord"),this.gl.enableVertexAttribArray(this.shaderProgram.textureCoordAttribute),this.shaderProgram.pMatrixUniform=this.gl.getUniformLocation(this.shaderProgram,"uPMatrix"),this.shaderProgram.mvMatrixUniform=this.gl.getUniformLocation(this.shaderProgram,"uMVMatrix"),this.shaderProgram.samplerUniform=this.gl.getUniformLocation(this.shaderProgram,"uSampler")},setMatrixUniforms:function(){this.gl.uniformMatrix4fv(this.shaderProgram.pMatrixUniform,!1,new Float32Array(this.pMatrix.matrix().flatten())),this.gl.uniformMatrix4fv(this.shaderProgram.mvMatrixUniform,!1,new Float32Array(this.mvMatrix.matrix().flatten()))},createImageTextureFromImage:function(t,e,i){var s=this.gl.createTexture();return this.handleImageTextureLoaded(this,s,t,e,i),s},createImageTextureFromSource:function(t,e,i){var s=new Image,r=this.gl.createTexture(),n=this;return s.onload=function(){n.handleImageTextureLoaded(n,r,s,e,i)},s.src=t,r},handleImageTextureLoaded:function(t,e,i,s,r){t.gl.bindTexture(t.gl.TEXTURE_2D,e),t.gl.texImage2D(t.gl.TEXTURE_2D,0,t.gl.RGBA,t.gl.RGBA,t.gl.UNSIGNED_BYTE,i),t.gl.texParameteri(t.gl.TEXTURE_2D,t.gl.TEXTURE_MAG_FILTER,r?r:t.gl.NEAREST),t.gl.texParameteri(t.gl.TEXTURE_2D,t.gl.TEXTURE_MIN_FILTER,s?s:t.gl.NEAREST),t.gl.texParameteri(t.gl.TEXTURE_2D,t.gl.TEXTURE_WRAP_S,t.gl.CLAMP_TO_EDGE),t.gl.texParameteri(t.gl.TEXTURE_2D,t.gl.TEXTURE_WRAP_T,t.gl.CLAMP_TO_EDGE),(s==t.gl.NEAREST_MIPMAP_NEAREST||s==t.gl.LINEAR_MIPMAP_NEAREST||s==t.gl.NEAREST_MIPMAP_LINEAR||s==t.gl.LINEAR_MIPMAP_LINEAR)&&t.gl.generateMipmap(t.gl.TEXTURE_2D),t.gl.bindTexture(t.gl.TEXTURE_2D,null)},deleteTexture:function(t){this.gl.deleteTexture(t)},dispose:function(){delete this.canvas,delete this.gl}},bigshot.VRRenderer=function(){},bigshot.VRRenderer.prototype={createTileCache:function(){},createTexturedQuadScene:function(){},createTexturedQuad:function(){},getViewportWidth:function(){},getViewportHeight:function(){},transformToWorld:function(){},transformWorldToScreen:function(){},transformToScreen:function(){},dispose:function(){},beginRender:function(){},endRender:function(){},onresize:function(){},resize:function(){},getElement:function(){}},bigshot.AbstractVRRenderer=function(){},bigshot.AbstractVRRenderer.prototype={transformToWorld:function(t){var e=this.mvMatrix.matrix().xPoint3Dhom1(t);return e},transformWorldToScreen:function(t){if(t.z>0)return null;var e=this.pMatrix.matrix().xPoint3Dhom(t);if(Math.abs(e.w)<Sylvester.precision)return null;var i=e.x,s=e.y,r=e.z,n=this.getViewportWidth(),a=this.getViewportHeight(),h={x:n/2*i/r+n/2,y:-(a/2)*s/r+a/2};return h},transformToScreen:function(t){var e=this.mvpMatrix.xPoint3Dhom(t);if(e.z<0)return null;var i=e.w;if(Math.abs(e.w)<Sylvester.precision)return null;var s=e.x,r=e.y,n=this.getViewportWidth(),a=this.getViewportHeight(),h={x:n/2*s/i+n/2,y:-(a/2)*r/i+a/2};return h}},bigshot.CSS3DVRRenderer=function(t){this.container=t,this.canvasOrigin=document.createElement("div"),this.canvasOrigin.style.WebkitTransformOrigin="0px 0px 0px",this.canvasOrigin.style.WebkitTransformStyle="preserve-3d",this.canvasOrigin.style.WebkitPerspective="600px",this.canvasOrigin.style.position="relative",this.canvasOrigin.style.left="50%",this.canvasOrigin.style.top="50%",this.container.appendChild(this.canvasOrigin),this.viewport=document.createElement("div"),this.viewport.style.WebkitTransformOrigin="0px 0px 0px",this.viewport.style.WebkitTransformStyle="preserve-3d",this.canvasOrigin.appendChild(this.viewport),this.world=document.createElement("div"),this.world.style.WebkitTransformOrigin="0px 0px 0px",this.world.style.WebkitTransformStyle="preserve-3d",this.viewport.appendChild(this.world),this.browser.removeAllChildren(this.world),this.view=null,this.mvMatrix=new bigshot.TransformStack,this.yaw=0,this.pitch=0,this.fov=0,this.pMatrix=new bigshot.TransformStack,this.onresize=function(){},this.viewportSize=null},bigshot.CSS3DVRRenderer.prototype={browser:new bigshot.Browser,dispose:function(){this.container.removeChild(this.canvasOrigin),delete this.canvasOrigin,delete this.mvMatrix,delete this.pMatrix},createTileCache:function(t,e,i){return new bigshot.ImageVRTileCache(t,e,i)},createTexturedQuadScene:function(){return new bigshot.CSS3DTexturedQuadScene(this.world,128,this.view)},createTexturedQuad:function(t,e,i,s){return new bigshot.CSS3DTexturedQuad(t,e,i,s)},getElement:function(){return this.container},supportsUpdate:function(){return!1},getViewportWidth:function(){return this.viewportSize?this.viewportSize.w:this.browser.getElementSize(this.container).w},getViewportHeight:function(){return this.viewportSize?this.viewportSize.h:this.browser.getElementSize(this.container).h},onresize:function(){},resize:function(t,e){""!=this.container.style.width&&(this.container.style.width=t+"px"),""!=this.container.style.height&&(this.container.style.height=e+"px")},beginRender:function(t,e,i,s){this.viewportSize=this.browser.getElementSize(this.container),this.yaw=t.y,this.pitch=t.p,this.fov=e;var r=.5*e*Math.PI/180,n=this.getViewportHeight()/2,a=n/Math.tan(r);this.mvMatrix.reset(),this.view=i,this.mvMatrix.translate(this.view),this.mvMatrix.rotateZ(s.r),this.mvMatrix.rotateX(s.p),this.mvMatrix.rotateY(s.y),this.mvMatrix.rotateY(this.yaw),this.mvMatrix.rotateX(this.pitch),this.pMatrix.reset(),this.pMatrix.perspective(this.fov,this.getViewportWidth()/this.getViewportHeight(),.1,100),this.mvpMatrix=this.pMatrix.matrix().multiply(this.mvMatrix.matrix()),this.canvasOrigin.style.WebkitPerspective=a+"px";for(var h=this.world.children.length-1;h>=0;--h)this.world.children[h].inWorld=1;this.world.style.WebkitTransform="rotate3d(1,0,0,"+-t.p+"deg) rotate3d(0,1,0,"+t.y+"deg) rotate3d(0,1,0,"+s.y+"deg) rotate3d(1,0,0,"+-s.p+"deg) rotate3d(0,0,1,"+-s.r+"deg) ",this.world.style.WebkitTransformStyle="preserve-3d",this.world.style.WebKitBackfaceVisibility="hidden",this.viewport.style.WebkitTransform="translateZ("+a+"px)"},endRender:function(){for(var t=this.world.children.length-1;t>=0;--t){var e=this.world.children[t];e.inWorld&&2==e.inWorld||(delete e.inWorld,this.world.removeChild(e))}this.viewportSize=null}},bigshot.Object.extend(bigshot.CSS3DVRRenderer,bigshot.AbstractVRRenderer),bigshot.Object.validate("bigshot.CSS3DVRRenderer",bigshot.VRRenderer),bigshot.CSS3DTexturedQuad=function(t,e,i,s){this.p=t,this.u=e,this.v=i,this.image=s},bigshot.CSS3DTexturedQuad.prototype={crossProduct:function(t,e){return{x:t.y*e.z-t.z*e.y,y:t.z*e.x-t.x*e.z,z:t.x*e.y-t.y*e.x}},vecToStr:function(t){return t.x+","+t.y+","+t.z},quadTransform:function(t,e,i){var s=this.crossProduct(e,i),r="matrix3d("+this.vecToStr(e)+",0,"+this.vecToStr(i)+",0,"+this.vecToStr(s)+",0,"+this.vecToStr(t)+",1)";return r},norm:function(t){return Math.sqrt(t.x*t.x+t.y*t.y+t.z*t.z)},render:function(t,e,i){var s=e/(this.image.width-1),r=1*e,n=this.p,a=this.u,h=this.v;this.image.style.position="absolute",this.image.inWorld&&1==this.image.inWorld||t.appendChild(this.image),this.image.inWorld=2,this.image.style.WebkitTransformOrigin="0px 0px 0px",this.image.style.WebkitTransform=this.quadTransform({x:(n.x+i.x)*r,y:(-n.y+i.y)*r,z:(n.z+i.z)*r},{x:a.x*s,y:-a.y*s,z:a.z*s},{x:h.x*s,y:-h.y*s,z:h.z*s})}},bigshot.CSS3DTexturedQuadScene=function(t,e,i){this.quads=new Array,this.world=t,this.scale=e,this.view=i},bigshot.CSS3DTexturedQuadScene.prototype={addQuad:function(t){this.quads.push(t)},render:function(){for(var t=0;t<this.quads.length;++t)this.quads[t].render(this.world,this.scale,this.view)}},bigshot.TexturedQuadScene=function(){},bigshot.TexturedQuadScene.prototype={addQuad:function(){},render:function(){}},bigshot.WebGLVRRenderer=function(t){this.container=t,this.canvas=document.createElement("canvas"),this.canvas.width=480,this.canvas.height=480,this.canvas.style.position="absolute",this.container.appendChild(this.canvas),this.webGl=new bigshot.WebGL(this.canvas),this.webGl.initShaders(),this.webGl.gl.clearColor(0,0,0,1),this.webGl.gl.blendFunc(this.webGl.gl.ONE,this.webGl.gl.ZERO),this.webGl.gl.enable(this.webGl.gl.BLEND),this.webGl.gl.disable(this.webGl.gl.DEPTH_TEST),this.webGl.gl.clearDepth(1);var e=this;this.buffers=new bigshot.TimedWeakReference(function(){return e.setupBuffers()},function(t){e.disposeBuffers(t)},1e3)},bigshot.WebGLVRRenderer.prototype={createTileCache:function(t,e,i){return new bigshot.TextureTileCache(t,e,i,this.webGl)},createTexturedQuadScene:function(){return new bigshot.WebGLTexturedQuadScene(this.webGl,this.buffers)},setupBuffers:function(){var t=this.webGl.gl.createBuffer(),e=this.webGl.gl.createBuffer();this.webGl.gl.bindBuffer(this.webGl.gl.ARRAY_BUFFER,e);var i=[0,0,1,0,1,1,0,1];this.webGl.gl.bufferData(this.webGl.gl.ARRAY_BUFFER,new Float32Array(i),this.webGl.gl.STATIC_DRAW);var s=this.webGl.gl.createBuffer();this.webGl.gl.bindBuffer(this.webGl.gl.ELEMENT_ARRAY_BUFFER,s);var r=[0,2,1,0,3,2];return this.webGl.gl.bufferData(this.webGl.gl.ELEMENT_ARRAY_BUFFER,new Uint16Array(r),this.webGl.gl.STATIC_DRAW),this.webGl.gl.bindBuffer(this.webGl.gl.ARRAY_BUFFER,e),this.webGl.gl.vertexAttribPointer(this.webGl.shaderProgram.textureCoordAttribute,2,this.webGl.gl.FLOAT,!1,0,0),this.webGl.gl.bindBuffer(this.webGl.gl.ARRAY_BUFFER,t),this.webGl.gl.vertexAttribPointer(this.webGl.shaderProgram.vertexPositionAttribute,3,this.webGl.gl.FLOAT,!1,0,0),{vertexPositionBuffer:t,textureCoordBuffer:e,vertexIndexBuffer:s}},dispose:function(){this.buffers.dispose(),this.container.removeChild(this.canvas),delete this.canvas,this.webGl.dispose(),delete this.webGl},disposeBuffers:function(t){this.webGl.gl.deleteBuffer(t.vertexPositionBuffer),this.webGl.gl.deleteBuffer(t.vertexIndexBuffer),this.webGl.gl.deleteBuffer(t.textureCoordBuffer)},getElement:function(){return this.canvas},supportsUpdate:function(){return!1},createTexturedQuad:function(t,e,i,s){return new bigshot.WebGLTexturedQuad(t,e,i,s)},getViewportWidth:function(){return this.webGl.gl.viewportWidth},getViewportHeight:function(){return this.webGl.gl.viewportHeight},beginRender:function(t,e,i,s){this.webGl.gl.viewport(0,0,this.webGl.gl.viewportWidth,this.webGl.gl.viewportHeight),this.webGl.pMatrix.reset(),this.webGl.pMatrix.perspective(e,this.webGl.gl.viewportWidth/this.webGl.gl.viewportHeight,.1,100),this.webGl.mvMatrix.reset(),this.webGl.mvMatrix.translate(i),this.webGl.mvMatrix.rotateZ(s.r),this.webGl.mvMatrix.rotateX(s.p),this.webGl.mvMatrix.rotateY(s.y),this.webGl.mvMatrix.rotateY(t.y),this.webGl.mvMatrix.rotateX(t.p),this.mvMatrix=this.webGl.mvMatrix,this.pMatrix=this.webGl.pMatrix,this.mvpMatrix=this.pMatrix.matrix().multiply(this.mvMatrix.matrix())},endRender:function(){},resize:function(t,e){this.canvas.width=t,this.canvas.height=e,""!=this.container.style.width&&(this.container.style.width=t+"px"),""!=this.container.style.height&&(this.container.style.height=e+"px")},onresize:function(){this.webGl.onresize()}},bigshot.Object.extend(bigshot.WebGLVRRenderer,bigshot.AbstractVRRenderer),bigshot.Object.validate("bigshot.WebGLVRRenderer",bigshot.VRRenderer),bigshot.TexturedQuad=function(){},bigshot.WebGLTexturedQuad=function(t,e,i,s){this.p=t,this.u=e,this.v=i,this.texture=s},bigshot.WebGLTexturedQuad.prototype={render:function(t,e,i,s){t.gl.bindBuffer(t.gl.ARRAY_BUFFER,e);var r=[this.p.x,this.p.y,this.p.z,this.p.x+this.u.x,this.p.y+this.u.y,this.p.z+this.u.z,this.p.x+this.u.x+this.v.x,this.p.y+this.u.y+this.v.y,this.p.z+this.u.z+this.v.z,this.p.x+this.v.x,this.p.y+this.v.y,this.p.z+this.v.z];t.gl.bufferData(t.gl.ARRAY_BUFFER,new Float32Array(r),t.gl.STATIC_DRAW),t.gl.activeTexture(t.gl.TEXTURE0),t.gl.bindTexture(t.gl.TEXTURE_2D,this.texture),t.gl.uniform1i(t.shaderProgram.samplerUniform,0),t.gl.bindBuffer(t.gl.ELEMENT_ARRAY_BUFFER,s),t.gl.drawElements(t.gl.TRIANGLES,6,t.gl.UNSIGNED_SHORT,0),t.gl.bindTexture(t.gl.TEXTURE_2D,null)}},bigshot.WebGLTexturedQuadScene=function(t,e){this.quads=new Array,this.webGl=t,this.buffers=e},bigshot.WebGLTexturedQuadScene.prototype={addQuad:function(t){this.quads.push(t)},render:function(){var t=this.buffers.get(),e=t.vertexPositionBuffer,i=t.textureCoordBuffer,s=t.vertexIndexBuffer;this.webGl.setMatrixUniforms();for(var r=0;r<this.quads.length;++r)this.quads[r].render(this.webGl,e,i,s)}},bigshot.VRPanoramaParameters=function(t){if(this.posterSize=0,this.emptyImage=null,this.suffix=null,this.width=0,this.height=0,this.container=null,this.maxTesselation=-1,this.tileSize=0,this.overlap=0,this.basePath=null,this.fileSystemType="folder",this.fileSystem=null,this.dataLoader=new bigshot.DefaultDataLoader,this.maxTextureMagnification=1,this.textureMagFilter=null,this.textureMinFilter=null,this.minFov=2,this.maxFov=90,this.minPitch=-90,this.maxPitch=90,this.minYaw=-360,this.maxYaw=720,this.yawOffset=0,this.pitchOffset=0,this.rollOffset=0,this.onload=null,this.renderer=null,this.fling=!0,this.flingScale=.004,t)for(var e in t)this[e]=t[e];return this.merge=function(t,e){for(var i in t)(e||!this[i])&&(this[i]=t[i])},this},bigshot.VRPanorama=function(t){bigshot.EventDispatcher.call(this);var e=this;if(this.parameters=t,this.maxTextureMagnification=t.maxTextureMagnification,this.container=t.container,this.browser=new bigshot.Browser,this.dragStart=null,this.dragDistance=0,this.hotspots=[],this.disposed=!1,this.transformOffsets={y:t.yawOffset,p:t.pitchOffset,r:t.rollOffset},this.state={rotation:{p:0,y:0,r:0},fov:45,translation:{x:0,y:0,z:0}},this.renderer=null,this.parameters.renderer)if("css"==this.parameters.renderer)this.renderer=new bigshot.CSS3DVRRenderer(this.container);else{if("webgl"!=this.parameters.renderer)throw new Error("Unknown renderer: "+this.parameters.renderer);this.renderer=new bigshot.WebGLVRRenderer(this.container)}else this.renderer=bigshot.WebGLUtil.isWebGLSupported()?new bigshot.WebGLVRRenderer(this.container):new bigshot.CSS3DVRRenderer(this.container);this.renderListeners=new Array,this.renderables=new Array,this.idleCounter=0,this.maxIdleCounter=-1,this.smoothrotatePermit=0;var i=function(t){return t.preventDefault&&t.preventDefault(),!1};this.fullScreenHandler=null,this.renderAsapPermitTaken=!1,this.sizeContainer=null;var s={facesLeft:6,faceLoaded:function(){this.facesLeft--,0==this.facesLeft&&e.parameters.onload&&e.parameters.onload()}},r=function(){s.faceLoaded()};this.vrFaces=new Array,this.vrFaces[0]=new bigshot.VRFace(this,"f",{x:-1,y:1,z:-1},2,{x:1,y:0,z:0},{x:0,y:-1,z:0},r),this.vrFaces[1]=new bigshot.VRFace(this,"b",{x:1,y:1,z:1},2,{x:-1,y:0,z:0},{x:0,y:-1,z:0},r),this.vrFaces[2]=new bigshot.VRFace(this,"l",{x:-1,y:1,z:1},2,{x:0,y:0,z:-1},{x:0,y:-1,z:0},r),this.vrFaces[3]=new bigshot.VRFace(this,"r",{x:1,y:1,z:-1},2,{x:0,y:0,z:1},{x:0,y:-1,z:0},r),this.vrFaces[4]=new bigshot.VRFace(this,"u",{x:-1,y:1,z:1},2,{x:1,y:0,z:0},{x:0,y:0,z:-1},r),this.vrFaces[5]=new bigshot.VRFace(this,"d",{x:-1,y:-1,z:-1},2,{x:1,y:0,z:0},{x:0,y:0,z:1},r);var n=function(t){return t.clientX?t:{clientX:t.changedTouches[0].clientX,clientY:t.changedTouches[0].clientY}};this.lastTouchStartAt=-1,this.allListeners={mousedown:function(t){return e.smoothRotate(),e.resetIdle(),e.dragMouseDown(t),i(t)},mouseup:function(t){return e.resetIdle(),e.dragMouseUp(t),i(t)},mousemove:function(t){return e.resetIdle(),e.dragMouseMove(t),i(t)},dblclick:function(t){return e.mouseDoubleClick(t),i(t)},touchstart:function(t){return e.smoothRotate(),e.lastTouchStartAt=(new Date).getTime(),e.resetIdle(),e.dragMouseDown(n(t)),i(t)},touchend:function(t){e.resetIdle();var s=e.dragMouseUp(n(t));return!s&&e.lastTouchStartAt>(new Date).getTime()-350&&e.mouseDoubleClick(n(t)),e.lastTouchStartAt=-1,i(t)},touchmove:function(t){return e.dragDistance>24&&(e.lastTouchStartAt=-1),e.resetIdle(),e.dragMouseMove(n(t)),i(t)}},this.addEventListeners(),this.onresizeHandler=function(){e.onresize()},this.browser.registerListener(window,"resize",this.onresizeHandler,!1),this.browser.registerListener(document.body,"orientationchange",this.onresizeHandler,!1),this.setPitch(0),this.setYaw(0),this.setFov(45)},bigshot.VRPanorama.DRAG_GRAB="grab",bigshot.VRPanorama.DRAG_PAN="pan",bigshot.VRPanorama.ONRENDER_BEGIN=0,bigshot.VRPanorama.ONRENDER_END=1,bigshot.VRPanorama.ONRENDER_TEXTURE_UPDATE=0,bigshot.VRPanorama.prototype={addHotspot:function(t){this.hotspots.push(t)},getParameters:function(){return this.parameters},setTranslation:function(t,e,i){this.state.translation.x=t,this.state.translation.y=e,this.state.translation.z=i},getTranslation:function(){return this.state.translation},setFov:function(t){t=Math.min(this.parameters.maxFov,t),t=Math.max(this.parameters.minFov,t),this.state.fov=t},getFov:function(){return this.state.fov},screenToPolar:function(t,e){var i=this.screenToRayDelta(t,e),s=$V([i.x,i.y,i.z,1]);s=Matrix.RotationX(this.getPitch()*Math.PI/180).ensure4x4().x(s),s=Matrix.RotationY(-this.getYaw()*Math.PI/180).ensure4x4().x(s);var r=s.e(1),n=s.e(2),a=s.e(3),h=Math.sqrt(r*r+a*a),o=180*Math.atan2(r,-a)/Math.PI,l=180*Math.atan2(n,h)/Math.PI,u={};return u.yaw=(o+360)%360,u.pitch=l,u},snapPitch:function(t){return t=Math.min(this.parameters.maxPitch,t),t=Math.max(this.parameters.minPitch,t)},setPitch:function(t){this.state.rotation.p=this.snapPitch(t)},circleDistance:function(t,e){if(e>t){var i=e-t,s=e-360-t;return Math.abs(i)<Math.abs(s)?i:s}var i=e-t,s=360-t+e;return Math.abs(i)<Math.abs(s)?i:s},circleSnapTo:function(t,e,i){var s=this.circleDistance(t,e),r=this.circleDistance(t,i);return Math.abs(s)<Math.abs(r)?e:i},snapYaw:function(t){return t%=360,0>t&&(t+=360),this.parameters.minYaw<this.parameters.maxYaw?(t>this.parameters.maxYaw||t<this.parameters.minYaw)&&(t=circleSnapTo(t,this.parameters.minYaw,this.parameters.maxYaw)):t>this.parameters.minYaw||t>this.parameters.maxYaw&&(t=circleSnapTo(t,this.parameters.minYaw,this.parameters.maxYaw)),t},setYaw:function(t){this.state.rotation.y=this.snapYaw(t)},getYaw:function(){return this.state.rotation.y},getPitch:function(){return this.state.rotation.p},dispose:function(){this.disposed=!0,this.browser.unregisterListener(window,"resize",this.onresizeHandler,!1),this.browser.unregisterListener(document.body,"orientationchange",this.onresizeHandler,!1),this.removeEventListeners();for(var t=0;t<this.vrFaces.length;++t)this.vrFaces[t].dispose();this.renderer.dispose()},createVREventData:function(t){var e=this.browser.getElementPosition(this.container);t.localX=t.clientX-e.x,t.localY=t.clientY-e.y,t.ray=this.screenToRay(t.localX,t.localY);var i=this.screenToPolar(t.localX,t.localY);return t.yaw=i.yaw,t.pitch=i.pitch,t.target=this,t.currentTarget=this,new bigshot.VREvent(t)},beginRender:function(t,e){this.onrender(bigshot.VRPanorama.ONRENDER_BEGIN,t,e),this.renderer.beginRender(this.state.rotation,this.state.fov,this.state.translation,this.transformOffsets)},addRenderListener:function(t){var e=new Array;e=e.concat(this.renderListeners),e.push(t),this.renderListeners=e},removeRenderListener:function(t){var e=new Array;e=e.concat(this.renderListeners);for(var i=0;i<e.length;++i)if(e[i]===t){e.splice(i,1);break}this.renderListeners=e},onrender:function(t,e,i){for(var s=this.renderListeners,r=0;r<s.length;++r)s[r](t,e,i)},endRender:function(t,e){for(var i in this.vrFaces)this.vrFaces[i].endRender();this.renderer.endRender(),this.onrender(bigshot.VRPanorama.ONRENDER_END,t,e)},addRenderable:function(t){var e=new Array;e.concat(this.renderables),e.push(t),this.renderables=e},removeRenderable:function(){var t=new Array;t.concat(this.renderables);for(var e=0;e<t.length;++e)if(t[e]==listener){t.splice(e,1);break}this.renderables=t},render:function(t,e){if(!this.disposed){this.beginRender(t,e);var i=this.renderer.createTexturedQuadScene();for(var s in this.vrFaces)this.vrFaces[s].render(i);for(var r=0;r<this.renderables.length;++r)this.renderables[r](this.renderer,i);i.render();for(var r=0;r<this.hotspots.length;++r)this.hotspots[r].layout();this.endRender(t,e)}},renderUpdated:function(t,e){if(!this.disposed&&this.renderer.supportsUpdate()){this.beginRender(t,e);var i=this.renderer.createTexturedQuadScene();for(var s in this.vrFaces)this.vrFaces[s].isUpdated()&&this.vrFaces[s].render(i);i.render();for(var r=0;r<this.hotspots.length;++r)this.hotspots[r].layout();this.endRender(t,e)}else this.render(t,e)},dragMode:bigshot.VRPanorama.DRAG_GRAB,setDragMode:function(t){this.dragMode=t},addEventListeners:function(){for(var t in this.allListeners)this.browser.registerListener(this.container,t,this.allListeners[t],!1)},removeEventListeners:function(){for(var t in this.allListeners)this.browser.unregisterListener(this.container,t,this.allListeners[t],!1)},dragMouseDown:function(t){this.dragStart={clientX:t.clientX,clientY:t.clientY},this.dragLast={clientX:t.clientX,clientY:t.clientY,dx:0,dy:0,dt:1e6,time:(new Date).getTime()},this.dragDistance=0},dragMouseUp:function(){if(null==this.dragStart||null==this.dragLast)return this.dragStart=null,void(this.dragLast=null);this.dragStart=null;var t=this.dragLast.dx,e=this.dragLast.dy,i=Math.sqrt(t*t+e*e),s=this.dragLast.dt,r=(new Date).getTime()-this.dragLast.time;this.dragLast=null;var n=s>0?i/s:0;if(n>.05&&250>r&&s>20&&this.parameters.fling){var a=this.state.fov/this.renderer.getViewportHeight(),h=(new Date).getTime(),o=this.parameters.flingScale;return t/=s,e/=s,this.smoothRotate(function(e){var i=(new Date).getTime()-h,s=Math.pow(2,-i*o),r=t*e*a*s;return s>.01?r:null},function(t){var i=(new Date).getTime()-h,s=Math.pow(2,-i*o),r=e*t*a*s;return s>.01?r:null},function(){return null}),!0}return this.smoothRotate(),!1},dragMouseMove:function(t){if(null!=this.dragStart&&null==this.currentGesture)if(this.dragMode==bigshot.VRPanorama.DRAG_GRAB){this.smoothRotate();var e=this.state.fov/this.renderer.getViewportHeight(),i=t.clientX-this.dragStart.clientX,s=t.clientY-this.dragStart.clientY;this.dragDistance+=i+s,this.setYaw(this.getYaw()-i*e),this.setPitch(this.getPitch()-s*e),this.renderAsap(),this.dragStart=t;var r=(new Date).getTime()-this.dragLast.time;r>20&&(this.dragLast={dx:this.dragLast.clientX-t.clientX,dy:this.dragLast.clientY-t.clientY,dt:r,clientX:t.clientX,clientY:t.clientY,time:(new Date).getTime()})}else{var e=.1*this.state.fov/this.renderer.getViewportHeight(),i=t.clientX-this.dragStart.clientX,s=t.clientY-this.dragStart.clientY;this.dragDistance=i+s,this.smoothRotate(function(){return i*e},function(){return s*e})}},onMouseDoubleClick:function(t,e,i){var s=this.createVREventData({type:"dblclick",clientX:t.clientX,clientY:t.clientY});this.fireEvent("dblclick",s),s.defaultPrevented||this.smoothRotateToXY(e,i)},mouseDoubleClick:function(t){var e=this.browser.getElementPosition(this.container);this.onMouseDoubleClick(t,t.clientX-e.x,t.clientY-e.y)},gestureStart:function(t){this.currentGesture={startFov:this.getFov(),scale:t.scale}},gestureEnd:function(){this.currentGesture=null},gestureChange:function(t){if(this.currentGesture){var e=this.currentGesture.startFov/t.scale;this.setFov(e),this.renderAsap()}},setMaxTextureMagnification:function(t){this.maxTextureMagnification=t},getMaxTextureMagnification:function(){return this.maxTextureMagnification},getMinFovFromViewportAndImage:function(){var t=this.renderer.getViewportHeight()/2,e=this.vrFaces[0].parameters.height;for(var i in this.vrFaces)e=Math.min(e,this.vrFaces[i].parameters.height);var s=this.maxTextureMagnification*e/2,r=t/s,n=180*Math.atan(r)/Math.PI;return 2*n},screenToRay:function(t,e){var i=this.screenToRayDelta(t,e),s=this.renderer.transformToWorld(i);return s=Matrix.RotationY(-this.transformOffsets.y*Math.PI/180).ensure4x4().xPoint3Dhom1(s),s=Matrix.RotationX(-this.transformOffsets.p*Math.PI/180).ensure4x4().xPoint3Dhom1(s),s=Matrix.RotationZ(-this.transformOffsets.r*Math.PI/180).ensure4x4().xPoint3Dhom1(s)},screenToRayDelta:function(t,e){var i=this.renderer.getViewportHeight()/2,s=this.renderer.getViewportWidth()/2,t=t-s,e=e-i,r=Math.tan(this.state.fov/2*Math.PI/180),n=r*this.renderer.getViewportWidth()/this.renderer.getViewportHeight(),a=t*n/s,h=e*r/i,o=-1;return{x:a,y:h,z:o}},smoothRotateToXY:function(t,e){var i=this.screenToPolar(t,e);this.smoothRotateTo(this.snapYaw(i.yaw),this.snapPitch(i.pitch),this.getFov(),this.state.fov/200)},ease:function(t,e,i,s){var r=40*i;s||(s=i/5);var n=i/1e3,a=t-e;return a=a>r?-i:-r>a?i:Math.abs(a)<s?-a:Math.abs(a)<n?0:-(i*a)/r},resetIdle:function(){this.idleCounter=0},idleTick:function(){if(!(this.maxIdleCounter<0)){++this.idleCounter,this.idleCounter==this.maxIdleCounter&&this.autoRotate();var t=this;setTimeout(function(){t.idleTick()},1e3)}},autoRotateWhenIdle:function(t){if(this.maxIdleCounter=t,this.idleCounter=0,!(0>t)&&this.maxIdleCounter>0){var e=this;setTimeout(function(){e.idleTick()},1e3)}},autoRotate:function(){var t=this,e=this.state.fov/400,i=e,s=i;this.smoothRotate(function(){var e=t.getYaw()+s;return t.parameters.minYaw<t.parameters.maxYaw?(e>t.parameters.maxYaw||e<t.parameters.minYaw)&&(s=-s):e>t.parameters.minYaw||e>t.parameters.maxYaw&&(s=-s),s},function(){return t.ease(t.getPitch(),0,i)},function(){return t.ease(t.getFov(),45,.1)})},smoothRotateTo:function(t,e,i,s){var r=this;this.smoothRotate(function(){var e=r.circleDistance(t,r.getYaw()),i=-r.ease(0,e,s);return Math.abs(i)>.01?i:null},function(){var t=r.ease(r.getPitch(),e,s);return Math.abs(t)>.01?t:null},function(){var t=r.ease(r.getFov(),i,s);return Math.abs(t)>.01?t:null})},smoothRotate:function(t,e,i){++this.smoothrotatePermit;var s=this.smoothrotatePermit;if(e||t||i){var r=this,n={dy:t,dp:e,df:i,t:(new Date).getTime()},a=function(){if(r.smoothrotatePermit==s){var t=(new Date).getTime(),e=t-n.t;n.t=t;var i=!1;if(n.dy){var h=n.dy(e);null!=h?(i=!0,r.setYaw(r.getYaw()+h)):n.dy=null}if(n.dp){var h=n.dp(e);null!=h?(i=!0,r.setPitch(r.getPitch()+h)):n.dp=null}if(n.df){var h=n.df(e);null!=h?(i=!0,r.setFov(r.getFov()+h)):n.df=null}r.render(),i&&r.browser.requestAnimationFrame(a,r.renderer.getElement())}};a()}},mouseWheel:function(t){var e=0;t||(t=window.event),t.wheelDelta?(e=t.wheelDelta/120,window.opera&&(e=-e)):t.detail&&(e=-t.detail),e&&this.mouseWheelHandler(e),t.preventDefault&&t.preventDefault(),t.returnValue=!1},mouseWheelHandler:function(t){var e=this,i=null;t>0&&this.getFov()>this.parameters.minFov&&(i=.9*this.getFov()),0>t&&this.getFov()<this.parameters.maxFov&&(i=this.getFov()/.9),null!=i&&this.smoothRotate(null,null,function(){var t=(i-e.getFov())/1.5;return Math.abs(t)>.01?t:null})},fullScreen:function(t){if(!this.fullScreenHandler){var e=document.createElement("div");e.style.position="absolute",e.style.fontSize="16pt",e.style.top="128px",e.style.width="100%",e.style.color="white",e.style.padding="16px",e.style.zIndex="9999",e.style.textAlign="center",e.style.opacity="0.75",e.innerHTML="<span style='border-radius: 16px; -moz-border-radius: 16px; padding: 16px; padding-left: 32px; padding-right: 32px; background:black'>Press Esc to exit full screen mode.</span>";var i=this;this.fullScreenHandler=new bigshot.FullScreen(this.container),this.fullScreenHandler.restoreSize=null==this.sizeContainer,this.fullScreenHandler.addOnResize(function(){i.onresize()}),this.fullScreenHandler.addOnClose(function(){if(e.parentNode)try{div.removeChild(e)}catch(t){}i.fullScreenHandler=null}),t&&this.fullScreenHandler.addOnClose(function(){t()}),this.removeEventListeners(),this.fullScreenHandler.open(),this.addEventListeners();var s=function(){i.render()};return setTimeout(s,1e3),setTimeout(s,2e3),setTimeout(s,3e3),this.fullScreenHandler.getRootElement()&&(this.fullScreenHandler.getRootElement().appendChild(e),setTimeout(function(){var t=.75,i=function(){if(t-=.02,e.parentNode)if(0>=t){e.style.display="none";try{div.removeChild(e)}catch(s){}}else e.style.opacity=t,setTimeout(i,20)};setTimeout(i,20)},3500)),function(){i.removeEventListeners(),i.fullScreenHandler.close(),i.addEventListeners()}}},onresize:function(){if(null!=this.fullScreenHandler&&this.fullScreenHandler.isFullScreen){this.container.style.width=window.innerWidth+"px",this.container.style.height=window.innerHeight+"px";var t=this.browser.getElementSize(this.container);this.renderer.resize(t.w,t.h)}else if(this.sizeContainer){var t=this.browser.getElementSize(this.sizeContainer);this.renderer.resize(t.w,t.h)}this.renderer.onresize(),this.renderAsap()},renderAsap:function(){if(!this.renderAsapPermitTaken&&!this.disposed){this.renderAsapPermitTaken=!0;var t=this;this.browser.requestAnimationFrame(function(){t.renderAsapPermitTaken=!1,t.render()},this.renderer.getElement())}},autoResizeContainer:function(t){this.sizeContainer=t}},bigshot.Object.extend(bigshot.VRPanorama,bigshot.EventDispatcher),bigshot.VRHotspot=function(t){this.panorama=t,this.clippingStrategy=bigshot.VRHotspot.CLIP_ADJUST(t)},bigshot.VRHotspot.CLIP_FRACTION=function(t,e){return function(i){var s={x0:Math.max(i.x,0),y0:Math.max(i.y,0),x1:Math.min(i.x+i.w,t.renderer.getViewportWidth()),y1:Math.min(i.y+i.h,t.renderer.getViewportHeight())},r=i.w*i.h,n=s.x1-s.x0,a=s.y1-s.y0;if(n>0&&a>0){var h=n*a;return h/r>=e}return!1}},bigshot.VRHotspot.CLIP_CENTER=function(t){return function(e){var i={x:e.x+e.w/2,y:e.y+e.h/2};return i.x>=0&&i.x<t.renderer.getViewportWidth()&&i.y>=0&&i.y<t.renderer.getViewportHeight()}},bigshot.VRHotspot.CLIP_ADJUST=function(t){return function(e){return e.x<0&&(e.w-=-e.x,e.x=0),e.y<0&&(e.h-=-e.y,e.y=0),e.x+e.w>t.renderer.getViewportWidth()&&(e.w=t.renderer.getViewportWidth()-e.x-1),e.y+e.h>t.renderer.getViewportHeight()&&(e.h=t.renderer.getViewportHeight()-e.y-1),e.w>0&&e.h>0}},bigshot.VRHotspot.CLIP_ZOOM=function(t,e,i){return function(s){if(s.x>=0&&s.y>=0&&s.x+e.w<t.renderer.getViewportWidth()&&s.y+e.h<t.renderer.getViewportHeight())return s.w=e.w,s.h=e.h,!0;var r=0;if(s.x<0&&(r=Math.max(-s.x,r)),s.y<0&&(r=Math.max(-s.y,r)),s.x+e.w>t.renderer.getViewportWidth()&&(r=Math.max(s.x+e.w-t.renderer.getViewportWidth(),r)),s.y+e.h>t.renderer.getViewportHeight()&&(r=Math.max(s.y+e.h-t.renderer.getViewportHeight(),r)),r/=t.renderer.getViewportHeight(),r>i)return!1;var n=1/(1+r);return s.w=e.w*n,s.h=e.w*n,s.x<0&&(s.x=0),s.y<0&&(s.y=0),s.x+s.w>t.renderer.getViewportWidth()&&(s.x=t.renderer.getViewportWidth()-s.w),s.y+s.h>t.renderer.getViewportHeight()&&(s.y=t.renderer.getViewportHeight()-s.h),!0}},bigshot.VRHotspot.CLIP_FADE=function(t,e){return function(i){var s=Math.min(i.x,i.y,t.renderer.getViewportWidth()-(i.x+i.w),t.renderer.getViewportHeight()-(i.y+i.h));return 0>=s?!1:e>=s?(i.opacity=s/e,!0):(i.opacity=1,!0)}},bigshot.VRHotspot.prototype={layout:function(){},rotate:function(t,e,i){var s=t*Math.PI/180,r=Matrix.Rotation(s,$V([e.x,e.y,e.z])).ensure4x4();return r.xPoint3Dhom1(i)},toVector:function(t,e){var i={x:0,y:0,z:-1};return i=this.rotate(-e,{x:1,y:0,z:0},i),i=this.rotate(-t,{x:0,y:1,z:0},i)},toScreen:function(t){var e=this.panorama.renderer.transformToScreen(t);return e},clip:function(t){return this.clippingStrategy(t)}},bigshot.VRPointHotspot=function(t,e,i,s,r,n){bigshot.VRHotspot.call(this,t),this.element=s,this.offsetX=r,this.offsetY=n,this.point=this.toVector(e,i)},bigshot.VRPointHotspot.prototype={layout:function(){var t=this.toScreen(this.point),e=!1;if(null!=t){var i=this.panorama.browser.getElementSize(this.element);t.w=i.w,t.h=i.h,t.x+=this.offsetX,t.y+=this.offsetY,this.clip(t)&&(this.element.style.top=t.y+"px",this.element.style.left=t.x+"px",this.element.style.width=t.w+"px",this.element.style.height=t.h+"px",t.opacity&&(this.element.style.opacity=t.opacity),this.element.style.visibility="inherit",e=!0)}e||(this.element.style.visibility="hidden")}},bigshot.Object.extend(bigshot.VRPointHotspot,bigshot.VRHotspot),bigshot.Object.validate("bigshot.VRPointHotspot",bigshot.VRHotspot),bigshot.VRRectangleHotspot=function(t,e,i,s,r,n){bigshot.VRHotspot.call(this,t),this.element=n,this.point0=this.toVector(e,i),this.point1=this.toVector(s,r)},bigshot.VRRectangleHotspot.prototype={layout:function(){var t=this.toScreen(this.point0),e=this.toScreen(this.point1),i=!1;if(null!=t&&null!=e){var s={x:t.x,y:t.y,opacity:1,w:e.x-t.x,h:e.y-t.y};this.clip(s)&&(this.element.style.top=s.y+"px",this.element.style.left=s.x+"px",this.element.style.width=s.w+"px",this.element.style.height=s.h+"px",this.element.style.visibility="inherit",i=!0)}i||(this.element.style.visibility="hidden")}},bigshot.Object.extend(bigshot.VRRectangleHotspot,bigshot.VRHotspot),bigshot.Object.validate("bigshot.VRRectangleHotspot",bigshot.VRHotspot),bigshot.AdaptiveLODMonitorParameters=function(t){if(this.vrPanorama=null,this.targetFps=30,this.tolerance=.3,this.rate=.1,this.minMag=1.5,this.maxMag=16,this.hqRenderMag=1.5,this.hqRenderDelay=2e3,this.hqRenderInterval=1e3,t)for(var e in t)this[e]=t[e];return this.merge=function(t,e){for(var i in t)(e||!this[i])&&(this[i]=t[i])},this},bigshot.AdaptiveLODMonitor=function(t){this.setParameters(t),this.currentAdaptiveMagnification=t.vrPanorama.getMaxTextureMagnification(),this.frames=0,this.samples=0,this.renderTimeTotal=0,this.renderTimeLast=0,this.samplesLast=0,this.startTime=0,this.lastRender=0,this.hqRender=!1,this.hqMode=!1,this.hqRenderWaiting=!1,this.enabled=!0;var e=this;this.listenerFunction=function(t,i,s){e.listener(t,i,s)}},bigshot.AdaptiveLODMonitor.prototype={averageRenderTime:function(){return this.samples>0?this.renderTimeTotal/this.samples:-1},setParameters:function(t){this.parameters=t,this.targetTime=1e3/this.parameters.targetFps,this.lowerTime=this.targetTime/(1+this.parameters.tolerance),this.upperTime=this.targetTime*(1+this.parameters.tolerance)},setEnabled:function(t){this.enabled=t},averageRenderTimeLast:function(){return this.samples>0?this.renderTimeLast/this.samplesLast:-1},getListener:function(){return this.listenerFunction},increaseDetail:function(){this.currentAdaptiveMagnification=Math.max(this.parameters.minMag,this.currentAdaptiveMagnification/(1+this.parameters.rate))},decreaseDetail:function(){this.currentAdaptiveMagnification=Math.min(this.parameters.maxMag,this.currentAdaptiveMagnification*(1+this.parameters.rate))},sample:function(){var t=(new Date).getTime()-this.startTime;if(this.samples++,this.renderTimeTotal+=t,this.samplesLast++,this.renderTimeLast+=t,this.samplesLast>4){var e=this.renderTimeLast/this.samplesLast;e<this.lowerTime?this.increaseDetail():e>this.upperTime&&this.decreaseDetail(),this.samplesLast=0,this.renderTimeLast=0}},hqRenderTick:function(){if(this.lastRender<(new Date).getTime()-this.parameters.hqRenderDelay)this.hqRender=!0,this.hqMode=!0,this.enabled&&(this.parameters.vrPanorama.setMaxTextureMagnification(this.parameters.hqRenderMag),this.parameters.vrPanorama.render()),this.hqRender=!1,this.hqRenderWaiting=!1;else{var t=this;setTimeout(function(){t.hqRenderTick()},this.parameters.hqRenderInterval)}},listener:function(t,e){if(this.enabled&&!this.hqRender){if(this.hqMode&&e==bigshot.VRPanorama.ONRENDER_TEXTURE_UPDATE)return void this.parameters.vrPanorama.setMaxTextureMagnification(this.parameters.minMag);if(this.hqMode=!1,this.parameters.vrPanorama.setMaxTextureMagnification(this.currentAdaptiveMagnification),this.frames++,(this.frames<20||this.frames%5==0)&&t==bigshot.VRPanorama.ONRENDER_BEGIN){this.startTime=(new Date).getTime(),this.lastRender=this.startTime;var i=this;setTimeout(function(){i.sample()},1),this.hqRenderWaiting||(this.hqRenderWaiting=!0,setTimeout(function(){i.hqRenderTick()},this.parameters.hqRenderInterval))}}}});
define("bigshot", ["glutils","sylvester"], (function (global) {
    return function () {
        var ret, fn;
        return ret || global.bigshot;
    };
}(this)));

